<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Duden pikkujoulut 2025</title>
  <meta property="og:title" content="Duden pikkujoulut 2025">
  <meta property="og:description" content="Tervetuloa Duden virtuaalisiin pikkujouluihin!">
  <meta property="og:image" content="https://www.dude.fi/content/uploads/xmas-og-2025.png">
  <meta property="og:url" content="https://tontut.dude.fi">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ„</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script defer data-domain="dude.fi" src="https://analytics.dude.fi/js/plausible.js"></script>
  <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }; plausible('pageview', { u: 'https://dude.fi/xmas' });</script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: 'Press Start 2P', monospace;
    }

    .game {
      width: 100%; height: 100%;
      display: flex; flex-direction: column;
    }

    .marquee-bar {
      background: #1a1a2e;
      border-bottom: 2px solid #4a4a6a;
      overflow: hidden;
      flex-shrink: 0;
      z-index: 51;
    }

    .marquee-content {
      display: flex;
      white-space: nowrap;
      width: fit-content;
      will-change: transform;
      backface-visibility: hidden;
    }

    .marquee-content[data-animated="true"] {
      animation: marquee var(--marquee-duration, 45s) linear infinite;
    }

    .marquee-bar:hover .marquee-content {
      animation-play-state: paused;
    }

    .marquee-content span {
      color: #f8d878;
      font-size: 10px;
      padding: 6px 50px;
      flex-shrink: 0;
    }

    @keyframes marquee {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(-50%, 0, 0); }
    }

    .hud {
      background: #000;
      padding: 8px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 4px solid #4a4a6a;
      flex-shrink: 0;
      z-index: 50;
    }

    .hud-title {
      color: #f8d878;
      font-size: 11px;
      text-shadow: 2px 2px #000;
      position: relative;
      top: 2px;
    }

    .hud-btn {
      background: #2a2a4a;
      border: 3px solid #6a6a8a;
      color: #fff;
      padding: 8px 14px;
      font-family: inherit;
      font-size: 9px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .hud-btn:hover, .hud-btn.active {
      background: #f8d878;
      color: #000;
      border-color: #f8d878;
    }

    /* Sound icon loading animation */
    .sound-loading {
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .sound-loading::before {
      content: 'â™ª';
      animation: note-bounce 0.8s ease-in-out infinite;
    }
    @keyframes note-bounce {
      0%, 100% { transform: translateY(0); opacity: 0.5; }
      50% { transform: translateY(-2px); opacity: 1; }
    }

    .screen {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
      background: linear-gradient(180deg, #0a1428 0%, #1a2848 30%, #2a3858 50%, #a0c0e0 70%, #d0e8f8 85%, #e8f4fc 100%);
    }

    /* Stars */
    .star {
      position: absolute;
      width: 3px; height: 3px;
      background: #fff;
      border-radius: 50%;
      animation: twinkle 2s ease-in-out infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* Moon */
    .moon {
      position: absolute;
      top: 8%; right: 12%;
      width: 50px; height: 50px;
      background: #f8f8d0;
      border-radius: 50%;
      box-shadow: 0 0 30px #f8f8a0, 0 0 60px #f8f8a060;
      z-index: 1;
    }

    /* Outside trees */
    .outside-tree {
      position: absolute;
      z-index: 2;
    }

    .outside-tree::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 60px solid #1a5020;
    }

    .outside-tree::after {
      content: '';
      position: absolute;
      bottom: 35px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 45px solid #208028;
    }

    .tree-trunk-out {
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 16px;
      background: #4a3020;
    }

    .tree-snow-cap {
      position: absolute;
      bottom: 78px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 8px;
      background: #e8f0f8;
      border-radius: 4px;
    }

    /* Falling snow */
    .outside-snow {
      position: absolute;
      width: 4px; height: 4px;
      background: #fff;
      border-radius: 50%;
      animation: snowfall 25s linear infinite;
      z-index: 5;
    }

    @keyframes snowfall {
      0% { transform: translateY(-50px) translateX(0); opacity: 0; }
      3% { opacity: 0.7; }
      25% { transform: translateY(25vh) translateX(8px); opacity: 0.6; }
      50% { transform: translateY(50vh) translateX(12px); opacity: 0.6; }
      75% { transform: translateY(75vh) translateX(18px); opacity: 0.5; }
      97% { opacity: 0.4; }
      100% { transform: translateY(100vh) translateX(20px); opacity: 0; }
    }

    /* Cabin */
    .cabin-frame {
      position: relative;
      width: 90%;
      max-width: 700px;
      min-width: 420px;
      aspect-ratio: 1/1;
      max-height: calc(100vh - 100px);
      z-index: 10;
    }

    .roof {
      position: absolute;
      top: -45px;
      left: -35px;
      right: -35px;
      height: 55px;
      z-index: 30;
    }

    .roof-main {
      position: absolute;
      bottom: 0;
      left: 0; right: 0;
      height: 45px;
      background: linear-gradient(180deg, #8b4513 0%, #6b3510 50%, #5a2a0a 100%);
      clip-path: polygon(0% 100%, 5% 0%, 95% 0%, 100% 100%);
    }

    .roof-snow {
      position: absolute;
      bottom: 36px;
      left: 4%; right: 4%;
      height: 16px;
      background: #e8f0f8;
      clip-path: polygon(0% 0%, 3% 100%, 12% 50%, 22% 100%, 35% 60%, 48% 100%, 62% 50%, 75% 100%, 88% 60%, 97% 100%, 100% 0%);
    }

    .room {
      position: absolute;
      inset: 0;
      background: #d4b896;
      border: 6px solid #2a1a0a;
      overflow: hidden;
    }

    /* Walls */
    .wall-top {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 55px;
      background: linear-gradient(180deg, #6a4828 0%, #785830 50%, #8a6838 100%);
      border-bottom: 5px solid #4a3018;
      z-index: 20;
    }

    .wall-left {
      position: absolute;
      top: 55px; left: 0; bottom: 25px;
      width: 35px;
      background: linear-gradient(90deg, #6a4828 0%, #785830 100%);
      border-right: 4px solid #4a3018;
      z-index: 20;
    }

    .wall-right {
      position: absolute;
      top: 55px; right: 0; bottom: 25px;
      width: 35px;
      background: linear-gradient(90deg, #785830 0%, #6a4828 100%);
      border-left: 4px solid #4a3018;
      z-index: 20;
    }

    .wall-bottom {
      position: absolute;
      bottom: 0; left: 35px; right: 35px;
      height: 25px;
      background: linear-gradient(180deg, #785830 0%, #5a4020 100%);
      border-top: 3px solid #4a3018;
      z-index: 20;
    }

    .floor {
      position: absolute;
      top: 55px; left: 35px; right: 35px; bottom: 25px;
      background: repeating-linear-gradient(90deg, #c8a070 0px, #c8a070 45px, #b89060 45px, #b89060 90px);
    }

    .floor::before {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(0deg, transparent 0px, transparent 43px, #a07848 43px, #a07848 45px);
    }

    /* Windows */
    .window {
      position: absolute;
      top: 8px;
      width: 100px;
      height: 42px;
      background: linear-gradient(180deg, #1a2848 0%, #2a3858 30%, #a0c0e0 70%, #d0e8f8 100%);
      border: 6px solid #4a3018;
      z-index: 25;
      overflow: hidden;
    }

    .window-left { left: 80px; }
    .window-right { right: 80px; }

    .window::before {
      content: '';
      position: absolute;
      top: 0; left: 50%;
      transform: translateX(-50%);
      width: 4px; height: 100%;
      background: #4a3018;
      z-index: 2;
    }

    .window::after {
      content: '';
      position: absolute;
      top: 50%; left: 0;
      width: 100%; height: 4px;
      background: #4a3018;
      z-index: 2;
    }

    .window-moon {
      position: absolute;
      top: 4px; right: 5px;
      width: 8px; height: 8px;
      background: #f8f8d0;
      border-radius: 50%;
      box-shadow: 0 0 4px #f8f8a0;
    }

    .snowflake {
      position: absolute;
      width: 2px; height: 2px;
      background: #fff;
      border-radius: 50%;
      animation: snow 3s linear infinite;
    }

    @keyframes snow {
      0% { transform: translateY(-10px); opacity: 0; }
      10% { opacity: 0.8; }
      100% { transform: translateY(55px); opacity: 0; }
    }

    /* Fireplace */
    .fireplace {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 160px;
      height: 110px;
      z-index: 26;
    }

    .fireplace-stone {
      position: absolute;
      bottom: 0; left: 0;
      width: 100%;
      height: 90px;
      background: linear-gradient(135deg, #787878 25%, #686868 25%, #686868 50%, #787878 50%, #787878 75%, #686868 75%);
      background-size: 16px 16px;
      border: 5px solid #484848;
    }

    .fireplace-opening {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 58px;
      background: #100404;
      border-radius: 40px 40px 0 0;
    }

    .fire {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 46px;
    }

    .flame {
      position: absolute;
      bottom: 0;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      animation: flicker 0.15s ease-in-out infinite alternate;
    }

    .flame1 { left: 10px; width: 38px; height: 40px; background: linear-gradient(#f80, #ff0); }
    .flame2 { left: 0; width: 22px; height: 30px; background: linear-gradient(#f60, #fa0); animation-delay: 0.05s; }
    .flame3 { right: 0; width: 22px; height: 32px; background: linear-gradient(#f60, #fa0); animation-delay: 0.1s; }

    @keyframes flicker {
      from { transform: scaleY(1) scaleX(1); }
      to { transform: scaleY(1.1) scaleX(0.9); }
    }

    .fire-glow {
      position: absolute;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 200px;
      background: radial-gradient(ellipse, rgba(255,128,0,0.25) 0%, transparent 70%);
      pointer-events: none;
      z-index: 5;
    }

    .mantle {
      position: absolute;
      top: 12px;
      left: -10px;
      width: calc(100% + 20px);
      height: 22px;
      background: linear-gradient(180deg, #a07050 0%, #785838 100%);
      border: 5px solid #4a3018;
    }

    .stockings {
      position: absolute;
      top: 34px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 27;
    }

    .stocking { width: 16px; height: 32px; }
    .stocking-top { width: 100%; height: 7px; background: #fff; border: 2px solid #ddd; }
    .stocking-foot { width: 100%; height: 25px; border-radius: 0 0 6px 4px; }
    .stocking:nth-child(odd) .stocking-foot { background: #d02020; }
    .stocking:nth-child(even) .stocking-foot { background: #20a020; }

    /* Dartboard on wall */
    .dartboard {
      position: absolute;
      top: 7px;
      right: 200px;
      width: 40px;
      height: 40px;
      background: #1a1a1a;
      border: 3px solid #402010;
      border-radius: 50%;
      z-index: 26;
    }

    .dartboard-rings {
      position: absolute;
      inset: 2px;
      border-radius: 50%;
      background:
        radial-gradient(circle, #d02020 0%, #d02020 8%, #20a020 8%, #20a020 20%, #f0e8d0 20%, #f0e8d0 32%, #1a1a1a 32%, #1a1a1a 44%, #f0e8d0 44%, #f0e8d0 56%, #d02020 56%, #d02020 68%, #20a020 68%, #20a020 80%, #1a1a1a 80%);
    }

    .dart {
      position: absolute;
      width: 3px;
      height: 12px;
      background: linear-gradient(180deg, #c0c0c0 0%, #808080 40%, #d02020 40%, #d02020 70%, #f0e080 70%);
      z-index: 27;
      transform-origin: bottom center;
    }

    .dart-1 { top: 8px; right: 206px; transform: rotate(-15deg); }
    .dart-2 { top: 12px; right: 198px; transform: rotate(10deg); }
    .dart-3 { top: 6px; right: 192px; transform: rotate(5deg); }

    /* Wreath on wall */
    .wreath {
      position: absolute;
      top: 7px;
      left: 200px;
      width: 40px;
      height: 40px;
      z-index: 26;
    }

    .wreath-ring {
      width: 100%;
      height: 100%;
      border: 9px solid #208020;
      border-radius: 50%;
    }

    .wreath-bow {
      position: absolute;
      top: -3px;
      left: 50%;
      transform: translateX(-50%);
      width: 18px;
      height: 12px;
      background: #d02020;
      clip-path: polygon(0% 50%, 20% 0%, 50% 40%, 80% 0%, 100% 50%, 80% 100%, 50% 60%, 20% 100%);
    }

    /* Tree */
    .tree {
      position: absolute;
      bottom: 36px;
      right: 50px;
      width: 110px;
      height: 145px;
      z-index: 18;
    }

    .tree-layer {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
    }

    .tree-l1 { bottom: 78%; width: 44px; height: 42px; background: linear-gradient(90deg, #1a6818 0%, #28a028 50%, #1a6818 100%); }
    .tree-l2 { bottom: 52%; width: 66px; height: 48px; background: linear-gradient(90deg, #186018 0%, #209020 50%, #186018 100%); }
    .tree-l3 { bottom: 22%; width: 90px; height: 54px; background: linear-gradient(90deg, #145814 0%, #188018 50%, #145814 100%); }

    .tree-trunk {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 32px;
      background: linear-gradient(90deg, #603010 0%, #805020 50%, #603010 100%);
      border: 3px solid #4a2008;
    }

    .tree-star {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 22px;
      height: 22px;
      background: #f8d800;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation: starPulse 1s ease-in-out infinite alternate;
    }

    @keyframes starPulse {
      from { filter: drop-shadow(0 0 4px #f8d800); }
      to { filter: drop-shadow(0 0 12px #f8f800); }
    }

    .ornament {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.3);
    }

    .orn-red { background: radial-gradient(circle at 30% 30%, #ff6060, #c00); }
    .orn-blue { background: radial-gradient(circle at 30% 30%, #6060ff, #00c); }
    .orn-gold { background: radial-gradient(circle at 30% 30%, #ffe060, #c90); }

    .tree-light {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: blink 0.8s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* Presents */
    .presents {
      position: absolute;
      bottom: 38px;
      right: 48px;
      z-index: 17;
    }

    .present {
      position: absolute;
      border: 3px solid rgba(0,0,0,0.3);
    }

    .present::before {
      content: '';
      position: absolute;
      top: 0; left: 50%;
      transform: translateX(-50%);
      width: 25%;
      height: 100%;
    }

    .p1 { bottom: 0; left: 0; width: 36px; height: 32px; background: linear-gradient(135deg, #f03030, #c01818); }
    .p1::before { background: #f8d800; }
    .p2 { bottom: 0; left: 42px; width: 32px; height: 26px; background: linear-gradient(135deg, #3070f0, #1850c0); }
    .p2::before { background: #fff; }
    .p3 { bottom: 30px; left: 18px; width: 28px; height: 24px; background: linear-gradient(135deg, #30d050, #18a030); }
    .p3::before { background: #f080a0; }

    /* Openable presents */
    .gift {
      position: absolute;
      cursor: pointer;
      z-index: 99;
      transition: transform 0.2s;
    }
    .gift:hover { transform: scale(1.1); }
    .gift-box {
      position: relative;
      border: 3px solid rgba(0,0,0,0.3);
      border-radius: 3px;
    }
    .gift-ribbon {
      position: absolute;
      top: 0; left: 50%;
      transform: translateX(-50%);
      width: 25%;
      height: 100%;
    }
    .gift-bow {
      position: absolute;
      top: -10px; left: 50%;
      transform: translateX(-50%);
      width: 20px; height: 12px;
    }
    .gift-bow::before, .gift-bow::after {
      content: '';
      position: absolute;
      width: 10px; height: 10px;
      border-radius: 50% 50% 0 50%;
      top: 2px;
    }
    .gift-bow::before { left: 0; transform: rotate(-30deg); }
    .gift-bow::after { right: 0; transform: rotate(30deg) scaleX(-1); }
    .gift-1 .gift-box { width: 40px; height: 35px; background: linear-gradient(135deg, #e03050, #b01830); }
    .gift-1 .gift-ribbon { background: #f8d800; }
    .gift-1 .gift-bow, .gift-1 .gift-bow::before, .gift-1 .gift-bow::after { background: #f8d800; }
    .gift-2 .gift-box { width: 35px; height: 30px; background: linear-gradient(135deg, #40a0f0, #2070c0); }
    .gift-2 .gift-ribbon { background: #fff; }
    .gift-2 .gift-bow, .gift-2 .gift-bow::before, .gift-2 .gift-bow::after { background: #fff; }
    .gift-3 .gift-box { width: 32px; height: 28px; background: linear-gradient(135deg, #50c060, #30a040); }
    .gift-3 .gift-ribbon { background: #f080b0; }
    .gift-3 .gift-bow, .gift-3 .gift-bow::before, .gift-3 .gift-bow::after { background: #f080b0; }
    .gift.opened { pointer-events: none; }
    .gift.opened .gift-box { animation: giftOpen 0.5s ease-out forwards; }
    .gift.opened .gift-bow { animation: bowFly 0.3s ease-out forwards; }
    @keyframes giftOpen {
      0% { transform: scale(1); }
      30% { transform: scale(1.2) rotate(-5deg); }
      50% { transform: scale(0.8) rotate(5deg); }
      100% { transform: scale(0) rotate(10deg); opacity: 0; }
    }
    @keyframes bowFly {
      to { transform: translateX(-50%) translateY(-30px) rotate(180deg); opacity: 0; }
    }
    .gift-content {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 24px;
      animation: contentPop 0.5s 0.2s ease-out forwards;
      white-space: nowrap;
      z-index: 99;
    }
    @keyframes contentPop {
      0% { transform: translate(-50%, -50%) scale(0); }
      60% { transform: translate(-50%, -50%) scale(1.3); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    .gift-msg {
      position: absolute;
      top: -40px; left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 8px;
      white-space: nowrap;
      opacity: 0;
      animation: msgFade 3s 0.3s ease-out forwards;
      z-index: 99;
    }
    @keyframes msgFade {
      0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Couch */
    .couch {
      position: absolute;
      bottom: 36px;
      left: 46px;
      width: 150px;
      height: 78px;
      z-index: 16;
    }

    .couch-back {
      position: absolute;
      top: 0;
      left: 10px;
      width: calc(100% - 20px);
      height: 40px;
      background: linear-gradient(180deg, #b03838 0%, #902828 100%);
      border: 4px solid #601010;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
    }

    .couch-seat {
      position: absolute;
      bottom: 10px;
      left: 0;
      width: 100%;
      height: 36px;
      background: linear-gradient(180deg, #c84848 0%, #a83838 100%);
      border: 4px solid #601010;
      border-radius: 5px;
    }

    .couch-arm {
      position: absolute;
      bottom: 10px;
      width: 18px;
      height: 52px;
      background: linear-gradient(180deg, #a83838, #883030);
      border: 4px solid #601010;
      border-radius: 5px;
    }

    .couch-arm-l { left: -5px; }
    .couch-arm-r { right: -5px; }

    .couch-legs { position: absolute; bottom: 0; width: 12px; height: 12px; background: #402020; }
    .couch-leg-l { left: 18px; }
    .couch-leg-r { right: 18px; }

    .pillow {
      position: absolute;
      top: 38px;
      width: 30px;
      height: 22px;
      border-radius: 5px;
      border: 2px solid rgba(0,0,0,0.2);
    }

    .pillow-1 { left: 22px; background: linear-gradient(135deg, #40b060, #208838); transform: rotate(-8deg); }
    .pillow-2 { right: 22px; background: linear-gradient(135deg, #f0b030, #c89020); transform: rotate(6deg); }

    /* Coffee table */
    .table {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 56px;
      z-index: 15;
    }

    .table-top {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 16px;
      background: linear-gradient(180deg, #b09070 0%, #907050 100%);
      border: 3px solid #604020;
      border-radius: 4px;
    }

    .table-leg {
      position: absolute;
      top: 14px;
      width: 10px;
      height: 28px;
      background: linear-gradient(90deg, #604020 0%, #806040 50%, #604020 100%);
      border: 3px solid #503018;
    }

    .table-leg-l { left: 16px; }
    .table-leg-r { right: 16px; }

    .mug {
      position: absolute;
      top: -20px;
      width: 18px;
      height: 20px;
      background: linear-gradient(90deg, #c03030, #e05050, #c03030);
      border-radius: 0 0 5px 5px;
      border: 3px solid #902020;
    }

    .mug::after {
      content: '';
      position: absolute;
      top: 5px;
      right: -8px;
      width: 8px;
      height: 11px;
      border: 3px solid #902020;
      border-left: none;
      border-radius: 0 8px 8px 0;
    }

    .mug-1 { left: 16px; }
    .mug-2 { left: 52px; }
    .mug-3 { right: 16px; }

    .steam {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 3px;
      height: 10px;
      background: rgba(255,255,255,0.6);
      animation: steam 2s ease-out infinite;
      border-radius: 3px;
    }

    @keyframes steam {
      0% { opacity: 0.7; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-12px); }
    }

    /* Rug */
    .rug {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 70px;
      background: radial-gradient(ellipse, #b01818 0%, #801010 100%);
      border: 8px solid #d8a020;
      border-radius: 5px;
      z-index: 5;
    }

    .rug::before {
      content: '';
      position: absolute;
      inset: 10px;
      border: 4px solid #d8a020;
      border-radius: 3px;
    }

    /* Bookshelf */
    .bookshelf {
      position: absolute;
      top: 65px;
      left: 50px;
      width: 80px;
      height: 100px;
      background: linear-gradient(90deg, #604020 0%, #785030 50%, #604020 100%);
      border: 4px solid #402818;
      z-index: 12;
    }

    .shelf { position: absolute; left: 0; width: 100%; height: 5px; background: #402010; }
    .shelf-1 { top: 32%; }
    .shelf-2 { top: 64%; }

    .books { position: absolute; left: 5px; right: 5px; display: flex; align-items: flex-end; gap: 3px; }
    .books-1 { bottom: 68%; height: 28%; }
    .books-2 { bottom: 36%; height: 26%; }
    .books-3 { bottom: 4%; height: 30%; }

    .book { flex-shrink: 0; border-radius: 1px; }

    /* Lamp */
    .lamp {
      position: absolute;
      bottom: 36px;
      left: 200px;
      width: 28px;
      height: 65px;
      z-index: 14;
    }

    .lamp-shade {
      position: absolute;
      top: 0;
      width: 100%;
      height: 30px;
      background: linear-gradient(180deg, #f8e8a0 0%, #d8c880 100%);
      clip-path: polygon(10% 0%, 90% 0%, 100% 100%, 0% 100%);
      border: 3px solid #c8b860;
    }

    .lamp-pole {
      position: absolute;
      top: 28px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 30px;
      background: #806040;
    }

    .lamp-base {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 22px;
      height: 10px;
      background: #604020;
      border-radius: 3px;
    }

    /* Plant */
    .plant {
      position: absolute;
      bottom: 36px;
      right: 200px;
      width: 32px;
      height: 55px;
      z-index: 14;
    }

    .pot {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 28px;
      height: 22px;
      background: linear-gradient(180deg, #c06020 0%, #904010 100%);
      clip-path: polygon(10% 0%, 90% 0%, 100% 100%, 0% 100%);
      border: 3px solid #703008;
    }

    .leaves {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
    }

    .leaf {
      position: absolute;
      width: 12px;
      height: 26px;
      background: #208028;
      border-radius: 50% 50% 50% 50% / 80% 80% 20% 20%;
    }

    .leaf-1 { transform: rotate(-30deg); left: -8px; }
    .leaf-2 { transform: rotate(0deg); left: 0; }
    .leaf-3 { transform: rotate(30deg); left: 8px; }

    /* Characters */
    .character {
      position: absolute;
      z-index: 22;
      cursor: pointer;
      transition: filter 0.15s;
    }

    .character:hover {
      z-index: 50;
      filter: drop-shadow(0 0 8px rgba(248, 216, 120, 0.8));
    }

    .character:has(.speech-bubble) {
      z-index: 60;
    }

    .char-sprite {
      position: relative;
      width: 70px;
      height: 100px;
      image-rendering: pixelated;
    }

    .char-pixels {
      position: absolute;
      width: 7.2px;
      height: 7.2px;
      background: transparent;
    }

    .char-shadow {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 55px;
      height: 16px;
      background: radial-gradient(ellipse, rgba(0,0,0,0.4) 0%, transparent 70%);
    }

    .char-tooltip {
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      border: 3px solid #f8d878;
      padding: 8px 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s;
      z-index: 100;
      border-radius: 4px;
    }

    .character:hover .char-tooltip { opacity: 1; }

    .char-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #f8d878;
    }

    .char-name { color: #f8d878; font-size: 9px; display: block; }
    .char-title { color: #aaa; font-size: 8px; margin-top: 4px; }

    /* Round glasses overlay */
    .char-glasses {
      position: absolute;
      top: 17px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 2px;
      z-index: 5;
    }
    .char-glasses-lens {
      width: 16px;
      height: 16px;
      border: 2px solid #604020;
      border-radius: 50%;
      background: transparent;
    }
    .char-glasses-bridge {
      width: 4px;
      height: 2px;
      background: #604020;
      align-self: center;
      margin: 0 -2px;
    }

    @media (max-width: 600px) {
      .char-glasses { top: 9px; left: 44%; }
      .char-glasses-lens { width: 10px; height: 10px; border-width: 1px; }
      .char-glasses-bridge { width: 2px; height: 1px; }
    }

    /* Speech bubbles */
    .speech-bubble {
      position: absolute;
      bottom: calc(100% + 5px);
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 3px solid #333;
      border-radius: 12px;
      padding: 6px 10px;
      color: #000;
      font-size: 8px;
      white-space: nowrap;
      z-index: 100;
      animation: bubblePop 3s ease-out forwards;
    }

    .speech-bubble::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: #333;
    }

    .speech-bubble::before {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #fff;
      margin-top: -3px;
      z-index: 1;
    }

    @keyframes bubblePop {
      0% { opacity: 0; transform: translateX(-50%) scale(0.5); }
      10% { opacity: 1; transform: translateX(-50%) scale(1.1); }
      20% { transform: translateX(-50%) scale(1); }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Character click animations */
    .character.anim-wave .char-sprite {
      animation: charWave 0.6s ease-in-out;
    }
    .character.anim-jump .char-sprite {
      animation: charJump 0.5s ease-out;
    }
    .character.anim-drink .char-sprite {
      animation: charDrink 0.8s ease-in-out;
    }
    .character.anim-dance .char-sprite {
      animation: charDance 0.6s ease-in-out;
    }
    @keyframes charWave {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-8deg); }
      50% { transform: rotate(8deg); }
      75% { transform: rotate(-5deg); }
    }
    @keyframes charJump {
      0%, 100% { transform: translateY(0); }
      40% { transform: translateY(-20px); }
      60% { transform: translateY(-18px); }
    }
    @keyframes charDrink {
      0%, 100% { transform: rotate(0deg) translateY(0); }
      30% { transform: rotate(-15deg) translateY(-5px); }
      50% { transform: rotate(-20deg) translateY(-8px); }
      70% { transform: rotate(-15deg) translateY(-5px); }
    }
    @keyframes charDance {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      25% { transform: translateX(-5px) rotate(-5deg); }
      50% { transform: translateX(5px) rotate(5deg); }
      75% { transform: translateX(-3px) rotate(-3deg); }
    }

    /* Idle animations for characters */
    .character.idle-sway .char-sprite {
      animation: idleSway 3s ease-in-out infinite;
    }
    .character.idle-breathe .char-sprite {
      animation: idleBreathe 2.5s ease-in-out infinite;
    }
    @keyframes idleSway {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(2deg); }
    }
    @keyframes idleBreathe {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(1.02); }
    }

    /* Santa sleigh flying across moon */
    .sleigh-shadow {
      position: absolute;
      width: 80px;
      height: 30px;
      opacity: 0;
      pointer-events: none;
      z-index: 5;
    }
    .sleigh-shadow.flying {
      animation: sleighFly 3s ease-in-out forwards;
    }
    @keyframes sleighFly {
      0% { opacity: 0; left: -100px; top: 60px; }
      10% { opacity: 0.8; }
      90% { opacity: 0.8; }
      100% { opacity: 0; left: 110%; top: 20px; }
    }

    /* Floor mat in front of fireplace */
    .floor-mat {
      position: absolute;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      width: 90px;
      height: 20px;
      background: linear-gradient(90deg, #8B4513 0%, #A0522D 20%, #8B4513 40%, #A0522D 60%, #8B4513 80%, #A0522D 100%);
      border-radius: 3px;
      z-index: 15;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }
    .floor-mat::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 5px;
      right: 5px;
      height: 2px;
      background: repeating-linear-gradient(90deg, #654321 0px, #654321 4px, transparent 4px, transparent 8px);
    }

    /* Sleeping cat in corner */
    .corner-cat {
      position: absolute;
      bottom: 32px;
      right: 15px;
      width: 35px;
      height: 20px;
      z-index: 18;
      cursor: pointer;
    }
    .cat-body {
      position: absolute;
      bottom: 0;
      width: 30px;
      height: 15px;
      background: #555;
      border-radius: 50% 50% 40% 40%;
    }
    .cat-head {
      position: absolute;
      bottom: 8px;
      left: 0;
      width: 14px;
      height: 12px;
      background: #555;
      border-radius: 50%;
    }
    .cat-ear {
      position: absolute;
      top: -4px;
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 6px solid #555;
    }
    .cat-ear.left { left: 1px; }
    .cat-ear.right { right: 1px; }
    .cat-tail {
      position: absolute;
      bottom: 5px;
      right: -8px;
      width: 15px;
      height: 5px;
      background: #555;
      border-radius: 0 10px 10px 0;
      transform-origin: left center;
      animation: tailWag 2s ease-in-out infinite;
    }
    @keyframes tailWag {
      0%, 100% { transform: rotate(-5deg); }
      50% { transform: rotate(10deg); }
    }
    .cat-zzz {
      position: absolute;
      top: -15px;
      left: 50%;
      font-size: 10px;
      opacity: 0;
      animation: zzz 2s ease-in-out infinite;
    }
    @keyframes zzz {
      0%, 100% { opacity: 0; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-5px); }
    }
    .corner-cat:hover .cat-body,
    .corner-cat:hover .cat-head { background: #666; }
    .corner-cat.awake .cat-zzz { display: none; }
    .corner-cat.awake .cat-body { animation: catStretch 1s ease-out; }
    @keyframes catStretch {
      0% { transform: scaleX(1); }
      50% { transform: scaleX(1.2) scaleY(0.8); }
      100% { transform: scaleX(1); }
    }

    /* Christmas countdown */
    .xmas-countdown {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      border: 2px solid #f8d878;
      padding: 8px 12px;
      font-size: 10px;
      color: #fff;
      z-index: 100;
      text-align: center;
      display: grid;
      gap: 3px;
    }
    @media (max-width: 1070px) {
      .xmas-countdown {
        top: 10px;
        bottom: auto;
      }
    }
    @media (max-width: 600px) {
      .xmas-countdown {
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        border-left: none;
        border-right: none;
        border-top: none;
      }
    }
    .countdown-label { color: #f8d878; font-size: 8px; margin-bottom: 4px; }
    .countdown-time {
      display: flex;
      gap: 2px;
      justify-content: center;
      align-items: center;
    }
    .countdown-unit {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .countdown-num {
      font-size: 18px;
      font-weight: bold;
      font-family: monospace;
    }
    .countdown-lbl {
      font-size: 8px;
      color: #aaa;
      margin-top: 2px;
    }
    .countdown-sep {
      font-size: 16px;
      font-weight: 300;
      margin: 0 2px;
      position: relative;
      top: -2px;
      opacity: 0.6;
    }
    .countdown-done { color: #4f4; font-size: 12px; }

    /* Santa */
    .santa {
      position: absolute;
      z-index: 24;
      cursor: pointer;
    }

    .santa-sprite {
      position: relative;
      width: 60px;
      height: 95px;
      image-rendering: pixelated;
    }

    .santa-pixels {
      position: absolute;
      width: 7px;
      height: 7px;
      background: transparent;
    }

    .santa-scroll {
      position: absolute;
      bottom: 25px;
      right: -20px;
      width: 24px;
      height: 32px;
      background: linear-gradient(180deg, #f8f0d8 0%, #e8d8c0 100%);
      border: 2px solid #a89070;
      border-radius: 2px;
      opacity: 0;
      transform: rotate(-10deg) scale(0.5);
      transition: all 0.3s ease;
      z-index: 25;
    }

    .santa-scroll::before {
      content: '';
      position: absolute;
      top: 3px; left: 3px; right: 3px;
      height: 2px;
      background: #a89070;
      box-shadow: 0 5px 0 #a89070, 0 10px 0 #a89070, 0 15px 0 #a89070, 0 20px 0 #a89070;
    }

    .santa.reading .santa-scroll {
      opacity: 1;
      transform: rotate(-10deg) scale(1);
    }

    .santa.reading .santa-sprite {
      animation: santaRead 0.8s ease-in-out;
    }

    @keyframes santaRead {
      0%, 100% { transform: translateY(0); }
      25% { transform: translateY(-3px); }
      75% { transform: translateY(2px); }
    }

    .santa-shadow {
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 18px;
      background: radial-gradient(ellipse, rgba(0,0,0,0.4) 0%, transparent 70%);
    }

    /* UI */
    .msg-btn {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: linear-gradient(180deg, #c02040 0%, #901030 100%);
      border: 4px solid #f8d878;
      color: #fff;
      padding: 12px 20px;
      font-family: inherit;
      font-size: 10px;
      cursor: pointer;
      z-index: 100;
      box-shadow: 0 4px 0 #600818;
    }

    .msg-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #600818; }
    .msg-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #600818; }

    .visitors {
      position: fixed;
      bottom: 12px;
      left: 16px;
      background: rgba(0,0,0,0.8);
      border: 3px solid #208030;
      padding: 8px 12px;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 4px;
    }

    .visitors-icon {
      width: 10px;
      height: 10px;
      background: #30d040;
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    .visitors-text {
      color: #30d040;
      font-size: 8px;
    }

    .visitors-count {
      color: #30d040;
      font-weight: bold;
    }

    .total-visitors {
      position: fixed;
      bottom: 11px;
      left: 220px;
      background: rgba(0,0,0,0.8);
      border: 3px solid #f8d878;
      padding: 4px 12px 8px 12px;
      z-index: 100;
      border-radius: 4px;
    }

    .total-visitors-text {
      color: #f8d878;
      font-size: 8px;
    }

    #totalCount {
      font-weight: bold;
    }

    .game-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .dialog {
      background: linear-gradient(180deg, #1a1a2e 0%, #0a0a18 100%);
      padding: 16px;
      z-index: 150;
      display: flex;
      flex-direction: column;
      /* Mobile defaults */
      position: fixed;
      top: 0; right: 0; bottom: 0;
      width: 360px;
      border-left: 4px solid #f8d878;
      transform: translateX(100%);
      transition: transform 0.3s;
    }

    .dialog.open { transform: translateX(0); }

    /* Desktop: sidebar layout like Twitch */
    @media (min-width: 601px) {
      .game {
        flex-direction: row;
      }
      .game-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }
      .dialog {
        position: relative;
        width: 360px;
        flex-shrink: 0;
        transform: none !important;
        border-left: 4px solid #f8d878;
        top: auto;
        right: auto;
        bottom: auto;
      }
      .dialog.closed {
        display: none;
      }
      .game-main .screen {
        flex: 1;
      }
    }

    .dialog-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .dialog-title { color: #f8d878; font-size: 11px; }

    .dialog-close {
      background: none;
      border: 3px solid #f8d878;
      color: #f8d878;
      width: 28px; height: 28px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dialog-close:hover { background: #f8d878; color: #000; }

    .dialog-footer {
      margin-top: 6px;
      padding-top: 12px;
      font-size: 7px;
      color: #666;
      text-align: center;
    }

    .dialog-footer a {
      color: #f8d878;
      text-decoration: none;
    }

    .dialog-footer a:hover {
      text-decoration: underline;
    }

    .hud-logo {
      color: #7effe1;
      margin-right: 8px;
      vertical-align: middle;
      display: inline-block;
      position: relative;
      top: -2px;
    }

    .hud-logo:hover {
      color: #fff;
    }

    .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .form-group { flex: 1; }
    .form-group.small { flex: 0 0 120px; }
    .form-group label { display: block; color: #f8d878; font-size: 8px; margin-bottom: 6px; }
    .form-group input { width: 100%; padding: 10px; background: #0a0a18; border: 3px solid #4a4a6a; color: #fff; font-family: inherit; font-size: 10px; }
    .form-group input:focus { outline: none; border-color: #f8d878; }

    .btn-send {
      width: 100%;
      padding: 14px;
      background: linear-gradient(180deg, #c02040 0%, #901030 100%);
      border: 4px solid #f8d878;
      color: #fff;
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-send:hover { background: linear-gradient(180deg, #f8d878 0%, #c8a858 100%); color: #000; }

    .messages { margin-top: 14px; flex: 1; overflow-y: auto; background: #0a0a18; border: 3px solid #4a4a6a; }
    .msg { padding: 10px; border-bottom: 1px solid #2a2a4a; font-size: 9px; line-height: 1.38; }
    .msg:last-child { border-bottom: none; }
    .msg.new-highlight { background: rgba(248, 216, 120, 0.15); border-left: 3px solid #f8d878; animation: newMsgFade 8s forwards; }
    @keyframes newMsgFade { 0% { background: rgba(248, 216, 120, 0.15); } 100% { background: transparent; } }
    .msg-author { color: #f8d878; margin-right: 3px; }
    .msg-text { color: #ddd; margin-top: 4px; line-height: 1.6; }
    .msg-time { color: #666; font-size: 7px; margin-top: 4px; display: inline; }
    .msg-footer { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
    .msg-heart {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      font-size: 10px;
      color: #666;
      display: inline-flex;
      align-items: center;
      gap: 3px;
      transition: color 0.1s, transform 0.1s;
      position: relative;
      top: 1px;
    }
    .msg-heart:hover { color: #e05080; }
    .msg-heart:active { transform: scale(1.3); color: #e05080; }
    .msg-heart.liked { color: #e05080; }
    .msg-heart svg { width: 12px; height: 12px; }
    .msg-heart.liked svg { fill: #e05080; }
    .no-msgs { text-align: center; color: #666; padding: 20px; font-size: 9px; }

    .toast {
      position: fixed;
      top: 60px; left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: #0a0a18;
      border: 4px solid #f8d878;
      padding: 12px 24px;
      color: #fff;
      font-size: 10px;
      z-index: 200;
      transition: transform 0.3s;
      opacity: 0;
      visibility: hidden;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .toast.error { border-color: #c02040; }

    /* Mobile */
    @media (max-width: 600px) {
      .hud-title { font-size: 8px; }
      .hud-btn { padding: 6px 10px; font-size: 8px; }
      .total-visitors { display: none; }
      .cabin-frame { width: 95%; aspect-ratio: 1/1; }
      .roof { top: -30px; left: -22px; right: -22px; height: 38px; }
      .roof-main { height: 32px; }
      .roof-snow { bottom: 26px; height: 12px; }
      .wall-top { height: 40px; }
      .wall-left, .wall-right { width: 26px; top: 40px; }
      .wall-bottom { height: 20px; left: 26px; right: 26px; }
      .floor { top: 40px; left: 26px; right: 26px; bottom: 20px; }
      .window { width: 70px; height: 42px; top: 6px; }
      .window-left { left: 32px; }
      .window-right { right: 32px; }
      .fireplace { width: 100px; height: 70px; }
      .fireplace-stone { height: 55px; }
      .fireplace-opening { width: 50px; height: 36px; }
      .fire { width: 36px; height: 28px; }
      .flame1 { width: 28px; height: 26px; left: 4px; }
      .flame2 { width: 16px; height: 20px; }
      .flame3 { width: 16px; height: 22px; }
      .mantle { height: 14px; top: 6px; }
      .stockings { top: 20px; gap: 4px; }
      .stocking { width: 10px; height: 18px; }
      .stocking-top { height: 5px; }
      .stocking-foot { height: 13px; }
      .dartboard { width: 24px; height: 24px; top: 8px; right: 115px; }
      .dart { height: 8px; width: 2px; }
      .dart-1 { top: 10px; right: 118px; }
      .dart-2 { top: 13px; right: 112px; }
      .dart-3 { top: 9px; right: 108px; }
      .wreath { width: 24px; height: 24px; top: 8px; left: 115px; }
      .wreath-ring { border-width: 5px; }
      .tree { width: 55px; height: 72px; right: 30px; bottom: 24px; }
      .tree-l1 { width: 22px; height: 22px; }
      .tree-l2 { width: 34px; height: 26px; }
      .tree-l3 { width: 46px; height: 30px; }
      .tree-trunk { width: 12px; height: 16px; }
      .tree-star { width: 11px; height: 11px; }
      .ornament { width: 6px; height: 6px; }
      .tree-light { width: 4px; height: 4px; }
      .presents { right: 28px; bottom: 24px; }
      .p1 { width: 20px; height: 17px; }
      .p2 { width: 17px; height: 14px; left: 22px; }
      .p3 { width: 16px; height: 13px; left: 10px; bottom: 16px; }
      .couch { width: 80px; height: 42px; left: 30px; bottom: 24px; }
      .couch-back { height: 20px; }
      .couch-seat { height: 20px; bottom: 6px; }
      .couch-arm { width: 10px; height: 28px; bottom: 6px; }
      .couch-legs { width: 8px; height: 8px; }
      .pillow { width: 18px; height: 13px; top: 20px; }
      .table { width: 60px; height: 30px; bottom: 26px; }
      .table-top { height: 8px; }
      .table-leg { width: 6px; height: 16px; top: 7px; }
      .mug { width: 10px; height: 12px; top: -12px; }
      .rug { width: 110px; height: 38px; bottom: 30px; border-width: 4px; }
      .bookshelf { display: none; }
      .lamp { display: none; }
      .plant { display: none; }
      .fire-glow { width: 150px; height: 100px; top: 55px; }
      .char-sprite { width: 44px; height: 64px; }
      .char-pixels { width: 4px; height: 4px; }
      .char-shadow { width: 30px; height: 8px; bottom: 6px; }
      .santa-sprite { width: 45px; height: 70px; }
      .santa-pixels { width: 5px; height: 5px; }
      .santa-shadow { width: 36px; height: 10px; }
      .form-row { flex-direction: column; }
      .form-group.small { flex: 1; }
      .msg-btn { padding: 10px 16px; font-size: 9px; bottom: 12px; right: 12px; }
      .moon { width: 35px; height: 35px; }
      .outside-tree { transform: scale(0.7); }
      .dialog { top: auto; bottom: 0; left: 0; right: 0; width: auto; max-height: 80vh; border-left: none; border-top: 4px solid #f8d878; transform: translateY(100%); }
      .dialog.open { transform: translateY(0); }
    }

    audio { display: none; }

    /* Floating messages */
    .float-msg {
      position: fixed;
      background: #fff;
      border: 4px solid #333;
      border-radius: 16px;
      padding: 12px 16px;
      max-width: 280px;
      z-index: 90;
      animation: floatUp 12s ease-out forwards;
      pointer-events: none;
      bottom: 15%;
    }

    /* Position set via inline style for randomization */

    .float-msg-author {
      color: #333;
      font-size: 9px;
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }

    .float-msg-text {
      color: #000;
      font-size: 10px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .float-msg-time {
      color: #888;
      font-size: 7px;
      margin-top: 6px;
      display: block;
    }

    .float-msg::after {
      content: '';
      position: absolute;
      bottom: -24px;
      left: 20px;
      border: 12px solid transparent;
      border-top-color: #333;
    }

    .float-msg::before {
      content: '';
      position: absolute;
      bottom: -16px;
      left: 24px;
      border: 8px solid transparent;
      border-top-color: #fff;
      z-index: 1;
    }

    .float-msg.right::after { left: auto; right: 20px; }
    .float-msg.right::before { left: auto; right: 24px; }

    /* New (live) messages - gold border with glow */
    .float-msg.new {
      border-color: #f8d878;
      box-shadow: 0 0 20px rgba(248, 216, 120, 0.6);
      animation: floatUp 12s ease-out forwards, newPulse 1s ease-in-out 3;
    }
    .float-msg.new::after { border-top-color: #f8d878; }

    @keyframes newPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(248, 216, 120, 0.6); }
      50% { box-shadow: 0 0 35px rgba(248, 216, 120, 0.9); }
    }

    @keyframes floatUp {
      0% { opacity: 0; transform: translateY(50px) scale(0.9); }
      5% { opacity: 1; transform: translateY(0) scale(1); }
      60% { opacity: 1; transform: translateY(-200px); }
      100% { opacity: 0; transform: translateY(-350px); }
    }

    @media (max-width: 600px) {
      .float-msg { max-width: 160px; padding: 8px 12px; bottom: 20%; }
      .float-msg-author { font-size: 7px; }
      .float-msg-text { font-size: 8px; }
      .float-msg-time { font-size: 6px; }
    }
  </style>
</head>
<body>
  <div class="game">
    <div class="game-main">
    <div class="marquee-bar">
      <div class="marquee-content" id="marqueeTrack">
        <span>ðŸŽ„ Dude vietti pikkujouluja 19.12.2025 ja luki viestejÃ¤ porukalla - laittakaa terveisiÃ¤ tulemaan! Dudet lomailee 22.12.2025â€“4.1.2026 vÃ¤lisen ajan. Joulupukin kuuma linja on auki jouluun asti, joten jÃ¤ttÃ¤kÃ¤Ã¤ ihmeessÃ¤ lisÃ¤Ã¤ terveisiÃ¤ niin kÃ¤ydÃ¤Ã¤n kurkkimassa pyhien yli. Tuki palvelee pyhien yli osoitteesta tuki@dude.fi.</span>
      </div>
    </div>
    <div class="hud">
      <div class="hud-title"><a href="https://www.dude.fi" target="_blank" class="hud-logo" title="Dude.fi"><svg width="55" height="12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2267.72 453.54"><path fill="currentColor" d="M950.26 211.64c0 37.66-12.7 111.12-97.79 111.12-85.61 0-98.4-73.47-98.4-111.12V5.23H590.91v217.92c0 138.73 97.78 221.55 261.55 221.55 163.39 0 260.93-82.82 260.93-221.55V5.23H950.26v206.41zM2264.41 127.17V5.23h-505.2v439.48h505.2V322.76h-345.08v-48.71h286.91v-98.17h-286.91v-48.71zM317.21 5.23H3v439.48h314.21c108.81 0 219.87-87.76 219.87-219.74 0-132.83-111.06-219.74-219.87-219.74zm-39.84 317.53H166.14v-195.4h111.23c57.58 0 97.7 45.79 97.7 97.61 0 52.51-40.12 97.79-97.7 97.79zM1485.51 5.23H1171.3v439.48h314.21c108.81 0 219.87-87.76 219.87-219.74 0-132.83-111.06-219.74-219.87-219.74zm-39.84 317.53h-111.23v-195.4h111.23c57.58 0 97.7 45.79 97.7 97.61 0 52.51-40.12 97.79-97.7 97.79z"/></svg></a> PIKKUJOULUT 2025</div>
      <button class="hud-btn" id="soundBtn">
        <span class="sound-loading">Ladataan joulutunnelmaa...</span>
      </button>
    </div>

    <div class="screen" id="screen">
      <div class="moon"></div>

      <!-- Cabin -->
      <div class="cabin-frame">
        <div class="roof">
          <div class="roof-main"></div>
          <div class="roof-snow"></div>
        </div>

        <div class="room" id="room">
          <div class="wall-top"></div>
          <div class="wall-left"></div>
          <div class="wall-right"></div>
          <div class="wall-bottom"></div>
          <div class="floor"></div>

          <!-- Windows -->
          <div class="window window-left">
            <div class="window-moon"></div>
          </div>
          <div class="window window-right"></div>

          <!-- Fireplace -->
          <div class="fireplace">
            <div class="mantle"></div>
            <div class="fireplace-stone">
              <div class="fireplace-opening">
                <div class="fire">
                  <div class="flame flame1"></div>
                  <div class="flame flame2"></div>
                  <div class="flame flame3"></div>
                </div>
              </div>
            </div>
            <div class="stockings">
              <div class="stocking"><div class="stocking-top"></div><div class="stocking-foot"></div></div>
              <div class="stocking"><div class="stocking-top"></div><div class="stocking-foot"></div></div>
              <div class="stocking"><div class="stocking-top"></div><div class="stocking-foot"></div></div>
              <div class="stocking"><div class="stocking-top"></div><div class="stocking-foot"></div></div>
            </div>
          </div>
          <div class="fire-glow"></div>

          <!-- Floor mat in front of fireplace -->
          <div class="floor-mat"></div>

          <!-- Openable gifts -->
          <div class="gift gift-1" id="gift1" style="left:30%;top:17%;">
            <div class="gift-bow"></div>
            <div class="gift-box"><div class="gift-ribbon"></div></div>
          </div>
          <div class="gift gift-2" id="gift2" style="left:38%;top:19%;">
            <div class="gift-bow"></div>
            <div class="gift-box"><div class="gift-ribbon"></div></div>
          </div>
          <div class="gift gift-3" id="gift3" style="left:34%;top:24%;">
            <div class="gift-bow"></div>
            <div class="gift-box"><div class="gift-ribbon"></div></div>
          </div>

          <!-- Wall decorations -->
          <div class="dartboard"><div class="dartboard-rings"></div></div>
          <div class="dart dart-1"></div>
          <div class="dart dart-2"></div>
          <div class="dart dart-3"></div>
          <div class="wreath"><div class="wreath-ring"></div><div class="wreath-bow"></div></div>

          <!-- Bookshelf -->
          <div class="bookshelf" id="bookshelf">
            <div class="shelf shelf-1"></div>
            <div class="shelf shelf-2"></div>
            <div class="books books-1" id="books1"></div>
            <div class="books books-2" id="books2"></div>
            <div class="books books-3" id="books3"></div>
          </div>

          <!-- Lamp -->
          <div class="lamp">
            <div class="lamp-shade"></div>
            <div class="lamp-pole"></div>
            <div class="lamp-base"></div>
          </div>

          <!-- Plant -->
          <div class="plant">
            <div class="pot"></div>
            <div class="leaves">
              <div class="leaf leaf-1"></div>
              <div class="leaf leaf-2"></div>
              <div class="leaf leaf-3"></div>
            </div>
          </div>

          <!-- Rug -->
          <div class="rug"></div>

          <!-- Couch -->
          <div class="couch">
            <div class="couch-back"></div>
            <div class="couch-arm couch-arm-l"></div>
            <div class="couch-arm couch-arm-r"></div>
            <div class="couch-seat">
              <div class="pillow pillow-1"></div>
              <div class="pillow pillow-2"></div>
            </div>
            <div class="couch-legs couch-leg-l"></div>
            <div class="couch-legs couch-leg-r"></div>
          </div>

          <!-- Table -->
          <div class="table">
            <div class="table-top">
              <div class="mug mug-1"><div class="steam"></div></div>
              <div class="mug mug-2"><div class="steam" style="animation-delay:0.7s"></div></div>
              <div class="mug mug-3"><div class="steam" style="animation-delay:1.4s"></div></div>
            </div>
            <div class="table-leg table-leg-l"></div>
            <div class="table-leg table-leg-r"></div>
          </div>

          <!-- Tree -->
          <div class="tree" id="tree">
            <div class="tree-star"></div>
            <div class="tree-layer tree-l1"></div>
            <div class="tree-layer tree-l2"></div>
            <div class="tree-layer tree-l3"></div>
            <div class="tree-trunk"></div>
          </div>

          <!-- Presents -->
          <div class="presents">
            <div class="present p1"></div>
            <div class="present p2"></div>
            <div class="present p3"></div>
          </div>

          <!-- Santa -->
          <div class="santa" id="santa" style="bottom: 34px; left: 50%; transform: translateX(-50%);">
            <div class="santa-sprite">
              <div class="santa-pixels" id="santaPixels"></div>
            </div>
            <div class="santa-scroll"></div>
            <div class="santa-shadow"></div>
          </div>

          <!-- Sleeping cat -->
          <div class="corner-cat" id="cornerCat">
            <div class="cat-head">
              <div class="cat-ear left"></div>
              <div class="cat-ear right"></div>
            </div>
            <div class="cat-body"></div>
            <div class="cat-tail"></div>
            <div class="cat-zzz">z</div>
          </div>
        </div>
      </div>

      <!-- Sleigh shadow for moon click -->
      <div class="sleigh-shadow" id="sleighShadow">
        <svg viewBox="0 0 80 30" fill="rgba(0,0,0,0.7)">
          <ellipse cx="20" cy="22" rx="8" ry="4"/>
          <ellipse cx="35" cy="22" rx="6" ry="3"/>
          <path d="M10 18 Q5 15 10 10 L55 8 Q60 8 58 15 L55 20 Q50 22 10 20 Z"/>
          <circle cx="60" cy="12" r="5"/>
          <path d="M58 8 Q70 5 75 10"/>
        </svg>
      </div>

      <!-- Christmas countdown -->
      <div class="xmas-countdown" id="xmasCountdown">
        <div class="countdown-label">JOULUUN</div>
        <div class="countdown-time" id="countdownTime">--:--:--</div>
      </div>
    </div>

    <button class="msg-btn" id="msgBtn">TERVEISET</button>

    <div class="visitors" id="visitors">
      <div class="visitors-icon"></div>
      <span class="visitors-text"><span class="visitors-count" id="visitorCount">1</span> <span id="visitorWord">tonttu</span> paikalla</span>
    </div>

    <div class="total-visitors" id="totalVisitors">
      <span class="total-visitors-text"><span id="totalCount">...</span> tonttua kÃ¤ynyt kurkkimassa</span>
    </div>
    </div><!-- /.game-main -->

    <div class="dialog" id="dialog">
      <div class="dialog-header">
        <span class="dialog-title">JOULUPUKIN KUUMA LINJA</span>
        <button class="dialog-close" id="closeBtn">X</button>
      </div>
    <form id="msgForm">
      <div class="form-row">
        <div class="form-group small">
          <label>NIMESI</label>
          <input type="text" id="author" maxlength="50" placeholder="Nimi" required>
        </div>
        <div class="form-group">
          <label>VIESTISI</label>
          <input type="text" id="message" maxlength="500" placeholder="HyvÃ¤Ã¤ joulua!" required>
        </div>
      </div>
      <input type="text" id="website" name="website" style="position:absolute;left:-9999px;opacity:0;height:0;" tabindex="-1" autocomplete="off">
      <button type="submit" class="btn-send">LÃ„HETÃ„</button>
    </form>
    <div class="messages" id="messages">
      <div class="no-msgs">Ladataan...</div>
    </div>
    <div class="dialog-footer">TekoÃ¤lyÃ¤ ON kÃ¤ytetty. <a href="https://github.com/digitoimistodude/dude" target="_blank">TÃ¤stÃ¤ GitHubiin.</a></div>
    </div><!-- /.dialog -->
  </div><!-- /.game -->

  <div class="toast" id="toast"></div>

  <audio id="music1" preload="auto">
    <source src="https://www.dude.fi/media/pixel-santas-workshop.mp3" type="audio/mpeg">
  </audio>
  <audio id="music2" preload="auto">
    <source src="https://www.dude.fi/media/pixel-sleigh-dreams.mp3" type="audio/mpeg">
  </audio>

  <script>
    (function() {
      // Fetch marquee message from API
      fetch('https://www.dude.fi/wp-json/xmas/v1/banner')
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.enabled_xmas && data.message_xmas) {
            var track = document.getElementById('marqueeTrack');
            if (track) {
              track.innerHTML = '<span>' + data.message_xmas + '</span>';
            }
          }
        })
        .catch(function() {});

      var team = [
        { name: 'Rolle', title: 'CTO', x: 73, y: 23, hair: '#4a3020', skin: '#ffd5c0', shirt: '#c03030', pants: '#2040a0', style: 'verylong', eyes: 'normal', brows: 'thick', glasses: true, goatee: true, says: ['Kippis!', 'HyvÃ¤Ã¤ joulua!', 'Onks glÃ¶gii?', 'Torille!', 'Ei huono!', 'Toimii kuin junan vessa!', 'Jes jes!', 'HyvÃ¤ meininki!', 'Noniin!', 'LÃ¤htee!', 'Arkkitehtuuri kuntoon!', 'Skaalautuu!', 'Infra pelittÃ¤Ã¤!', 'Deployataan!', 'Tekninen velka?', 'Refaktoroidaan!', 'Koodataan tuotannossa!'] },
        { name: 'Juha', title: 'CEO', x: 45, y: 36, hair: '#4a4a50', skin: '#ffe0cc', shirt: '#2050c0', pants: '#303050', style: 'beard', eyes: 'small', brows: 'thin', sayFast: true, says: ['HyvÃ¤Ã¤ joulua!', 'Strategia!', 'MissÃ¤ on glÃ¶gi?', 'LisÃ¤laskutusta!', 'TÃ¶ihin tontut!', 'Deadline huomenna!', 'Palaveri!', 'Laskutetaan!', 'Kiitos tiimille!', 'Kiitos asiakkaille!', 'Projektit rullaa!', 'Hienoa tyÃ¶tÃ¤!'] },
        { name: 'Arto', title: 'Senior Dev', x: 18, y: 52, hair: '#5a4030', skin: '#ffd0b0', shirt: '#208030', pants: '#304030', style: 'beard', eyes: 'normal', brows: 'normal', glasses: true, says: ['PHP on paras!', 'WordPress ftw!', 'Kippis!', 'Debugataan!', 'TÃ¤Ã¤ on helppo!', 'Tehty ennenkin!', 'Klassikko!', 'Toimii locaalisti!', 'Ei mun koneella!', 'Cachet tyhjÃ¤ksi!', 'Koodataan tuotannossa!'] },
        { name: 'Elias', title: 'Senior Dev', x: 58, y: 40, hair: '#2a2020', skin: '#ffd5c0', shirt: '#8040a0', pants: '#3a3a4a', style: 'curly', eyes: 'wide', brows: 'normal', says: ['Toimii!', 'Git push!', 'Kahvia!', 'Joulupukki!', 'Eiku hetkinen...', 'No niin!', 'SelvÃ¤ homma!', 'Kokeillaan!', 'Hmm...', 'Ai niin!'] },
        { name: 'Tuomas', title: 'Senior Dev', x: 32, y: 56, hair: '#6a5040', skin: '#ffd0b0', shirt: '#d06020', pants: '#4a4035', style: 'beard', eyes: 'normal', brows: 'thick', says: ['Koodi toimii!', 'Refaktoroidaan!', 'Nice!', 'Kippis!', 'SiistiÃ¤!', 'TÃ¤Ã¤ on hyvÃ¤!', 'Jepa!', 'Ihan ok!', 'Voisko parantaa?', 'NÃ¤ppÃ¤rÃ¤Ã¤!'] },
        { name: 'Jenni', title: 'Developer', x: 10, y: 68, hair: '#4ab8b8', skin: '#ffe5d5', shirt: '#c04080', pants: '#4a3545', style: 'verylong', eyes: 'big', brows: 'thin', female: true, says: ['HyvÃ¤Ã¤ joulua!', 'Mahtavaa!', 'Koodataan!', 'Jee!', 'Ihana joulu!', 'Wohoo!', 'Kivaa!', 'JoulufiilistÃ¤!', 'KyllÃ¤pÃ¤ on kivaa!', 'Yay!'] },
        { name: 'Joni', title: 'Designer', x: 86, y: 44, hair: '#2a2520', skin: '#ffd5c0', shirt: '#20a0a0', pants: '#2a4545', style: 'short', eyes: 'normal', brows: 'normal', says: ['Design on!', 'Pikselit!', 'Figma time!', 'Kaunis!', 'TyylikÃ¤s!', 'NÃ¤yttÃ¤Ã¤ hyvÃ¤ltÃ¤!', 'Valmis!', 'Kerning!', 'Whitespace!', 'Grid!'] },
        { name: 'Sanna', title: 'Designer', x: 24, y: 34, hair: '#c03020', skin: '#ffe5d5', shirt: '#2a2a2a', pants: '#1a1a1a', style: 'long', eyes: 'big', brows: 'thin', glasses: true, female: true, says: ['VÃ¤rit kohdalleen!', 'Tyylii!', 'Kaunista!', 'Jess!', 'Ihanaa!', 'Perfecto!', 'Love it!', 'Ai niin kaunista!', 'Diggaan!', 'Yes!'] },
        { name: 'Luka', title: 'Developer', x: 70, y: 54, hair: '#3a3030', skin: '#e8c0a0', shirt: '#3040c0', pants: '#2a2a4a', style: 'medium', eyes: 'normal', brows: 'normal', glasses: true, says: ['Toimii!', 'Bueno!', 'Kippis!', 'Mahtavaa!', 'Muy bien!', 'Erinomaista!', 'SelvÃ¤!', 'Perfecto!', 'HyvÃ¤Ã¤ joulua!', 'Loistavaa!'] },
        { name: 'Maria', title: 'Developer', x: 14, y: 82, hair: '#4a3525', skin: '#ffd5c0', shirt: '#60a040', pants: '#3a4535', style: 'medium', eyes: 'big', brows: 'thin', female: true, says: ['Koodataan!', 'HyvÃ¤Ã¤ joulua!', 'Kahvia!', 'Nice!', 'Loistavaa!', 'Jippii!', 'Valmista!', 'MennÃ¤Ã¤n!', 'Hienoa!', 'Jatkuu!'] },
        { name: 'Miska', title: 'Developer', x: 44, y: 66, hair: '#5a4a40', skin: '#ffd0b0', shirt: '#805030', pants: '#4a4035', style: 'short', eyes: 'small', brows: 'thick', says: ['Mergeen!', 'Kippis!', 'Toimii!', 'Fixattu!', 'Homma hanskassa!', 'Jees!', 'Roger!', 'Main vihreenÃ¤!', 'Pushattu!', 'Done!'] },
        { name: 'Nadya', title: 'Developer', x: 78, y: 50, hair: '#1a1515', skin: '#ffd5c0', shirt: '#c03060', pants: '#4a3040', style: 'verylong', eyes: 'big', brows: 'thin', female: true, says: ['Deployed!', 'Works!', 'Kippis!', 'HyvÃ¤Ã¤ joulua!', 'Perfect!', 'Amazing!', 'Done!', 'Cheers!', 'All good!', 'Merry Christmas!'] },
        { name: 'Otto', title: 'Developer', x: 30, y: 78, hair: '#4a4035', skin: '#ffd5c0', shirt: '#a0a030', pants: '#3a3a30', style: 'short', eyes: 'normal', brows: 'normal', says: ['Koodataan!', 'Testit vihreenÃ¤!', 'Kahvia!', 'Nice!', 'Jep jep!', 'Onnistuu!', 'HeittÃ¤mÃ¤llÃ¤!', 'Coverage ok!', 'Ajellaan!', 'Hyvin menee!'] },
        { name: 'William', title: 'Developer', x: 64, y: 74, hair: '#3a3530', skin: '#ffd0b0', shirt: '#6040a0', pants: '#3a3045', style: 'medium', eyes: 'wide', brows: 'normal', glasses: true, says: ['Shipped!', 'Let\'s go!', 'Kippis!', 'Toimii!', 'Awesome!', 'Nice one!', 'Leggo!', 'Cheers!', 'On fire!', 'Woohoo!'] }
      ];

      function isMobile() {
        return window.innerWidth <= 600;
      }

      function createSprite(p) {
        var hair = p.hair;
        var skin = p.skin;
        var shirt = p.shirt;
        var pants = p.pants;
        var style = p.style;
        var eyes = p.eyes || 'normal';
        var hasBeard = style == 'beard';
        var hasGoatee = p.goatee;
        var hasGlasses = p.glasses;
        var isFemale = p.female;
        var s = isMobile() ? 4 : 7;
        var px = [];

        // Simpler 10x16 sprite for better iOS compatibility
        // Hair row 0-1
        px.push({x:3,y:0,c:hair},{x:4,y:0,c:hair},{x:5,y:0,c:hair},{x:6,y:0,c:hair});
        px.push({x:2,y:1,c:hair},{x:3,y:1,c:hair},{x:4,y:1,c:hair},{x:5,y:1,c:hair},{x:6,y:1,c:hair},{x:7,y:1,c:hair});

        // Face rows 2-5
        px.push({x:2,y:2,c:skin},{x:3,y:2,c:skin},{x:4,y:2,c:skin},{x:5,y:2,c:skin},{x:6,y:2,c:skin},{x:7,y:2,c:skin});
        // Eyes row 3
        px.push({x:2,y:3,c:skin},{x:3,y:3,c:'#333'},{x:4,y:3,c:skin},{x:5,y:3,c:skin},{x:6,y:3,c:'#333'},{x:7,y:3,c:skin});
        // Nose/cheeks row 4
        px.push({x:2,y:4,c:skin},{x:3,y:4,c:skin},{x:4,y:4,c:skin},{x:5,y:4,c:skin},{x:6,y:4,c:skin},{x:7,y:4,c:skin});
        if (isFemale) { px.push({x:3,y:4,c:'#ffb0a0'},{x:6,y:4,c:'#ffb0a0'}); }
        // Mouth row 5 - small centered mouth
        px.push({x:2,y:5,c:skin},{x:3,y:5,c:skin},{x:6,y:5,c:skin},{x:7,y:5,c:skin});
        var mouthCol = isFemale ? '#cc4444' : '#995544';
        px.push({x:4,y:5,c:mouthCol},{x:5,y:5,c:mouthCol});

        // Beard overlay
        if (hasBeard) {
          px.push({x:2,y:4,c:hair},{x:7,y:4,c:hair});
          px.push({x:2,y:5,c:hair},{x:3,y:5,c:hair},{x:4,y:5,c:hair},{x:5,y:5,c:hair},{x:6,y:5,c:hair},{x:7,y:5,c:hair});
          px.push({x:3,y:6,c:hair},{x:4,y:6,c:hair},{x:5,y:6,c:hair},{x:6,y:6,c:hair});
        }

        // Goatee (chin only, no side beard)
        if (hasGoatee) {
          px.push({x:4,y:5,c:hair},{x:5,y:5,c:hair}); // lower face
          px.push({x:4,y:6,c:hair},{x:5,y:6,c:hair}); // chin
        }

        // Long hair sides
        if (style == 'long' || style == 'verylong' || isFemale) {
          px.push({x:1,y:2,c:hair},{x:8,y:2,c:hair});
          px.push({x:1,y:3,c:hair},{x:8,y:3,c:hair});
          px.push({x:1,y:4,c:hair},{x:8,y:4,c:hair});
        }
        if (style == 'verylong') {
          px.push({x:1,y:5,c:hair},{x:8,y:5,c:hair});
          px.push({x:1,y:6,c:hair},{x:8,y:6,c:hair});
          px.push({x:1,y:7,c:hair},{x:8,y:7,c:hair});
          px.push({x:1,y:8,c:hair},{x:8,y:8,c:hair});
          px.push({x:1,y:9,c:hair},{x:8,y:9,c:hair});
        }

        // Neck
        var nY = hasBeard ? 7 : 6;
        px.push({x:4,y:nY,c:skin},{x:5,y:nY,c:skin});

        // Shirt
        var sY = nY + 1;
        px.push({x:3,y:sY,c:shirt},{x:4,y:sY,c:shirt},{x:5,y:sY,c:shirt},{x:6,y:sY,c:shirt});
        px.push({x:2,y:sY+1,c:shirt},{x:3,y:sY+1,c:shirt},{x:4,y:sY+1,c:shirt},{x:5,y:sY+1,c:shirt},{x:6,y:sY+1,c:shirt},{x:7,y:sY+1,c:shirt});
        px.push({x:1,y:sY+1,c:skin},{x:8,y:sY+1,c:skin}); // hands
        px.push({x:2,y:sY+2,c:shirt},{x:3,y:sY+2,c:shirt},{x:4,y:sY+2,c:shirt},{x:5,y:sY+2,c:shirt},{x:6,y:sY+2,c:shirt},{x:7,y:sY+2,c:shirt});

        // Pants
        var pY = sY + 3;
        px.push({x:3,y:pY,c:pants},{x:4,y:pY,c:pants},{x:5,y:pY,c:pants},{x:6,y:pY,c:pants});
        px.push({x:3,y:pY+1,c:pants},{x:4,y:pY+1,c:pants},{x:5,y:pY+1,c:pants},{x:6,y:pY+1,c:pants});
        // Shoes
        px.push({x:3,y:pY+2,c:'#222'},{x:4,y:pY+2,c:'#222'},{x:5,y:pY+2,c:'#222'},{x:6,y:pY+2,c:'#222'});

        return px.map(function(p) { return (p.x*s)+'px '+(p.y*s)+'px 0 '+p.c; }).join(',');
      }

      function createSantaSprite() {
        var s = isMobile() ? 5 : 7;
        var px = [];
        var red = '#c81818';
        var white = '#f0f0f0';
        var skin = '#ffd5c0';
        var belt = '#1a1a1a';
        var gold = '#d8a020';

        // Simpler Santa - 8x14 grid
        // Hat
        px.push({x:3,y:0,c:red},{x:4,y:0,c:red},{x:5,y:0,c:white});
        px.push({x:2,y:1,c:red},{x:3,y:1,c:red},{x:4,y:1,c:red},{x:5,y:1,c:red});
        px.push({x:1,y:2,c:white},{x:2,y:2,c:white},{x:3,y:2,c:white},{x:4,y:2,c:white},{x:5,y:2,c:white},{x:6,y:2,c:white});
        // Face
        px.push({x:1,y:3,c:skin},{x:2,y:3,c:skin},{x:3,y:3,c:skin},{x:4,y:3,c:skin},{x:5,y:3,c:skin},{x:6,y:3,c:skin});
        px.push({x:1,y:4,c:skin},{x:2,y:4,c:'#222'},{x:3,y:4,c:skin},{x:4,y:4,c:skin},{x:5,y:4,c:'#222'},{x:6,y:4,c:skin});
        px.push({x:3,y:4,c:'#e09090'},{x:4,y:4,c:'#e09090'}); // nose
        // Beard
        px.push({x:0,y:5,c:white},{x:1,y:5,c:white},{x:2,y:5,c:white},{x:3,y:5,c:white},{x:4,y:5,c:white},{x:5,y:5,c:white},{x:6,y:5,c:white},{x:7,y:5,c:white});
        px.push({x:1,y:6,c:white},{x:2,y:6,c:white},{x:3,y:6,c:white},{x:4,y:6,c:white},{x:5,y:6,c:white},{x:6,y:6,c:white});
        px.push({x:2,y:7,c:white},{x:3,y:7,c:white},{x:4,y:7,c:white},{x:5,y:7,c:white});
        // Body
        px.push({x:1,y:8,c:red},{x:2,y:8,c:red},{x:3,y:8,c:red},{x:4,y:8,c:red},{x:5,y:8,c:red},{x:6,y:8,c:red});
        px.push({x:0,y:8,c:skin},{x:7,y:8,c:skin}); // hands
        px.push({x:1,y:9,c:belt},{x:2,y:9,c:belt},{x:3,y:9,c:gold},{x:4,y:9,c:gold},{x:5,y:9,c:belt},{x:6,y:9,c:belt});
        px.push({x:1,y:10,c:red},{x:2,y:10,c:red},{x:3,y:10,c:red},{x:4,y:10,c:red},{x:5,y:10,c:red},{x:6,y:10,c:red});
        px.push({x:1,y:11,c:white},{x:2,y:11,c:white},{x:3,y:11,c:white},{x:4,y:11,c:white},{x:5,y:11,c:white},{x:6,y:11,c:white});
        // Boots
        px.push({x:1,y:12,c:'#111'},{x:2,y:12,c:'#111'},{x:5,y:12,c:'#111'},{x:6,y:12,c:'#111'});

        return px.map(function(p) { return (p.x*s)+'px '+(p.y*s)+'px 0 '+p.c; }).join(',');
      }

      function lightenColor(hex, percent) {
        var num = parseInt(hex.slice(1), 16);
        var r = Math.min(255, (num >> 16) + Math.round(255 * percent / 100));
        var g = Math.min(255, ((num >> 8) & 0x00FF) + Math.round(255 * percent / 100));
        var b = Math.min(255, (num & 0x0000FF) + Math.round(255 * percent / 100));
        return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
      }

      function darkenColor(hex, percent) {
        var num = parseInt(hex.slice(1), 16);
        var r = Math.max(0, (num >> 16) - Math.round(255 * percent / 100));
        var g = Math.max(0, ((num >> 8) & 0x00FF) - Math.round(255 * percent / 100));
        var b = Math.max(0, (num & 0x0000FF) - Math.round(255 * percent / 100));
        return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
      }

      var room = document.getElementById('room');
      var screen = document.getElementById('screen');

      function renderCharacters() {
        var existing = room.querySelectorAll('.character');
        for (var i = 0; i < existing.length; i++) {
          existing[i].remove();
        }

        team.forEach(function(p) {
          var el = document.createElement('div');
          el.className = 'character';
          el.style.left = p.x + '%';
          el.style.top = p.y + '%';
          var glassesHtml = p.glasses ? '<div class="char-glasses"><div class="char-glasses-lens"></div><div class="char-glasses-bridge"></div><div class="char-glasses-lens"></div></div>' : '';
          el.innerHTML =
            '<div class="char-sprite">' +
              '<div class="char-pixels" style="box-shadow:' + createSprite(p) + '"></div>' +
              glassesHtml +
            '</div>' +
            '<div class="char-shadow"></div>' +
            '<div class="char-tooltip">' +
              '<span class="char-name">' + p.name + '</span>' +
              '<span class="char-title">' + p.title + '</span>' +
            '</div>';
          room.appendChild(el);
        });

        // Render Santa
        document.getElementById('santaPixels').style.boxShadow = createSantaSprite();
      }

      renderCharacters();

      // Santa click handler
      document.getElementById('santa').addEventListener('click', function() {
        var santa = document.getElementById('santa');
        var existing = santa.querySelector('.speech-bubble');
        if (existing) existing.remove();

        var bubble = document.createElement('div');
        bubble.className = 'speech-bubble';
        bubble.textContent = 'Git commit... eiku hyvÃ¤Ã¤ joulua!';
        santa.appendChild(bubble);
        setTimeout(function() { bubble.remove(); }, 3500);
      });

      var resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(renderCharacters, 200);
      });

      // Stars
      for (var st = 0; st < 50; st++) {
        var star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 45 + '%';
        star.style.animationDelay = Math.random() * 2 + 's';
        screen.appendChild(star);
      }

      // Outside trees
      var treePositions = [
        { left: '3%', bottom: '58%', scale: 1 },
        { left: '10%', bottom: '62%', scale: 0.8 },
        { right: '5%', bottom: '60%', scale: 0.9 },
        { right: '12%', bottom: '56%', scale: 0.7 },
        { left: '20%', bottom: '65%', scale: 0.5 },
        { right: '20%', bottom: '63%', scale: 0.6 }
      ];

      treePositions.forEach(function(pos) {
        var treeEl = document.createElement('div');
        treeEl.className = 'outside-tree';
        if (pos.left) treeEl.style.left = pos.left;
        if (pos.right) treeEl.style.right = pos.right;
        treeEl.style.bottom = pos.bottom;
        treeEl.style.transform = 'scale(' + pos.scale + ')';
        treeEl.innerHTML = '<div class="tree-snow-cap"></div><div class="tree-trunk-out"></div>';
        screen.appendChild(treeEl);
      });

      // Outside falling snow - peaceful slow fall
      for (var os = 0; os < 40; os++) {
        var snowEl = document.createElement('div');
        snowEl.className = 'outside-snow';
        snowEl.style.left = Math.random() * 100 + '%';
        snowEl.style.top = '-20px';
        snowEl.style.animationDelay = Math.random() * 20 + 's';
        snowEl.style.animationDuration = (20 + Math.random() * 15) + 's';
        screen.appendChild(snowEl);
      }

      // Tree ornaments
      var tree = document.getElementById('tree');
      var ornPos = [
        {x:35,y:38,c:'red'},{x:60,y:35,c:'blue'},{x:25,y:55,c:'gold'},{x:70,y:52,c:'red'},
        {x:40,y:65,c:'blue'},{x:58,y:68,c:'gold'},{x:20,y:78,c:'red'},{x:75,y:75,c:'blue'}
      ];
      ornPos.forEach(function(o) {
        var el = document.createElement('div');
        el.className = 'ornament orn-' + o.c;
        el.style.left = o.x + '%';
        el.style.top = o.y + '%';
        tree.appendChild(el);
      });

      var lightCols = ['#f00','#ff0','#0f0','#0ff','#f0f'];
      for (var li = 0; li < 14; li++) {
        var lightEl = document.createElement('div');
        lightEl.className = 'tree-light';
        var col = lightCols[li % 5];
        lightEl.style.cssText = 'left:' + (15+Math.random()*70) + '%;top:' + (28+Math.random()*58) + '%;background:' + col + ';box-shadow:0 0 5px ' + col + ';animation-delay:' + (li*0.12) + 's';
        tree.appendChild(lightEl);
      }

      // Books
      var bookCols = ['#c33','#36c','#3a5','#d82','#84a','#da2'];
      ['books1','books2','books3'].forEach(function(id) {
        var row = document.getElementById(id);
        if (!row) return;
        for (var bi = 0; bi < 6; bi++) {
          var bookEl = document.createElement('div');
          bookEl.className = 'book';
          bookEl.style.width = (4 + Math.random() * 5) + 'px';
          bookEl.style.height = (60 + Math.random() * 40) + '%';
          bookEl.style.background = bookCols[Math.floor(Math.random() * bookCols.length)];
          row.appendChild(bookEl);
        }
      });

      // Window snow
      document.querySelectorAll('.window').forEach(function(win) {
        for (var wi = 0; wi < 6; wi++) {
          var flake = document.createElement('div');
          flake.className = 'snowflake';
          flake.style.left = (10 + Math.random() * 80) + '%';
          flake.style.animationDelay = (Math.random() * 3) + 's';
          flake.style.animationDuration = (2 + Math.random() * 2) + 's';
          win.appendChild(flake);
        }
      });

      // Dialog
      var dialog = document.getElementById('dialog');
      var msgBtn = document.getElementById('msgBtn');
      var closeBtn = document.getElementById('closeBtn');

      // Desktop: open by default, toggle with button
      // Mobile: closed by default, open with button
      function isDesktop() {
        return window.innerWidth > 600;
      }

      function updateDialogState() {
        if (isDesktop()) {
          // Desktop: sidebar mode - use 'closed' class
          dialog.classList.remove('open');
          if (!dialog.classList.contains('closed')) {
            // Open by default on desktop
          }
        } else {
          // Mobile: overlay mode - use 'open' class
          dialog.classList.remove('closed');
        }
      }

      // Initial state
      updateDialogState();
      window.addEventListener('resize', updateDialogState);

      msgBtn.onclick = function() {
        if (isDesktop()) {
          dialog.classList.toggle('closed');
        } else {
          dialog.classList.add('open');
        }
      };

      closeBtn.onclick = function() {
        if (isDesktop()) {
          dialog.classList.add('closed');
        } else {
          dialog.classList.remove('open');
        }
      };

      // Close dialog when clicking outside (mobile only)
      document.addEventListener('click', function(e) {
        if (!isDesktop() && dialog.classList.contains('open') && !dialog.contains(e.target) && e.target.id !== 'msgBtn') {
          dialog.classList.remove('open');
        }
      });

      document.getElementById('msgForm').onsubmit = function(e) {
        e.preventDefault();
        var authorVal = document.getElementById('author').value.trim();
        var messageVal = document.getElementById('message').value.trim();
        if (!authorVal || !messageVal) return;

        // Show own message as floating bubble instantly and mark as just submitted to prevent duplicate
        showFloatingMessage(authorVal, messageVal, new Date().toISOString(), true);
        window.justSubmittedMsg = authorVal + '::' + messageVal;
        setTimeout(function() { window.justSubmittedMsg = null; }, 10000);

        fetch('https://www.dude.fi/wp-json/xmas/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ author: authorVal, message: messageVal, website: document.getElementById('website').value })
        })
        .then(function(res) {
          if (res.ok) {
            showToast('Tervehdys lÃ¤hetetty!');
            document.getElementById('msgForm').reset();
            loadMessages();
          } else {
            return res.json().then(function(err) {
              showToast(err.message || 'Virhe!', true);
            });
          }
        })
        .catch(function() {
          showToast('Yhteysvirhe!', true);
        });
      };

      // Heart likes - localStorage tracking
      function getLikedMessages() {
        try {
          return JSON.parse(localStorage.getItem('xmas_likes_2025') || '[]');
        } catch (e) { return []; }
      }

      function hasLiked(id) {
        return getLikedMessages().indexOf(id) !== -1;
      }

      function markAsLiked(id) {
        var liked = getLikedMessages();
        if (liked.indexOf(id) === -1) {
          liked.push(id);
          try {
            localStorage.setItem('xmas_likes_2025', JSON.stringify(liked));
          } catch (e) {}
        }
      }

      function likeMessage(id, btn) {
        if (hasLiked(id)) return;
        // Instant update - no waiting
        markAsLiked(id);
        btn.disabled = true;
        btn.classList.add('liked');
        btn.querySelector('svg').setAttribute('fill', 'currentColor');
        var countSpan = btn.querySelector('span');
        var newCount = (countSpan ? parseInt(countSpan.textContent) || 0 : 0) + 1;
        if (countSpan) {
          countSpan.textContent = newCount;
        } else {
          btn.insertAdjacentHTML('beforeend', '<span>' + newCount + '</span>');
        }
        // Fire and forget - API call in background
        fetch('https://www.dude.fi/wp-json/xmas/v1/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id })
        }).catch(function() {});
      }

      function loadMessages() {
        fetch('https://www.dude.fi/wp-json/xmas/v1/messages')
          .then(function(res) {
            if (res.ok) return res.json();
            throw new Error();
          })
          .then(function(msgs) {
            var el = document.getElementById('messages');
            if (msgs.length == 0) {
              el.innerHTML = '<div class="no-msgs">Ole ensimmÃ¤inen tervehtijÃ¤!</div>';
            } else {
              el.innerHTML = msgs.map(function(m) {
                var isLiked = hasLiked(m.id);
                var likeCount = m.likes || 0;
                return '<div class="msg">' +
                  '<span class="msg-author">' + esc(m.author) + ':</span>' +
                  '<span class="msg-text">' + esc(m.message) + '</span>' +
                  '<div class="msg-footer">' +
                    '<span class="msg-time">' + fmt(m.timestamp) + '</span>' +
                    '<button class="msg-heart' + (isLiked ? ' liked' : '') + '" data-id="' + esc(m.id) + '" ' + (isLiked ? 'disabled' : '') + '>' +
                      '<svg viewBox="0 0 24 24" fill="' + (isLiked ? 'currentColor' : 'none') + '" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>' +
                      (likeCount > 0 ? '<span>' + likeCount + '</span>' : '') +
                    '</button>' +
                  '</div>' +
                '</div>';
              }).join('');
              el.querySelectorAll('.msg-heart:not([disabled])').forEach(function(btn) {
                btn.onclick = function() { likeMessage(btn.dataset.id, btn); };
              });
            }
          })
          .catch(function() {
            // Don't clear messages on error - keep existing content
          });
      }

      function esc(s) {
        // First, convert any already-escaped &lt;3 back to <3 (from PHP sanitization)
        s = s.replace(/&lt;3/g, '<3');
        var d = document.createElement('div');
        d.textContent = s;
        // Convert <3 to heart emoji (after escaping for XSS safety)
        return d.innerHTML.replace(/&lt;3/g, 'â¤ï¸');
      }

      function fmt(t) {
        if (!t) return '';
        var now = new Date();
        var then = new Date(t);
        var diff = Math.floor((now - then) / 1000);
        if (diff < 60) return 'juuri nyt';
        if (diff < 3600) return Math.floor(diff / 60) + ' min sitten';
        if (diff < 86400) return Math.floor(diff / 3600) + ' h sitten';
        return Math.floor(diff / 86400) + ' pv sitten';
      }

      // Initial load and polling setup moved to after loadMessages override

      // Music - simple iOS compatible
      var music1 = document.getElementById('music1');
      var music2 = document.getElementById('music2');
      var soundBtn = document.getElementById('soundBtn');
      var playing = false;
      var audioReady = false;
      var current = Math.random() > 0.5 ? music1 : music2;

      music1.volume = 0.3;
      music2.volume = 0.3;

      // Sound button states (icon + MUSIIKKI label, aria-labels for screen readers)
      var iconPlaying = '<svg width="14" height="14" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path fill="currentColor" d="M146.7 26.7h26.7v26.7h-26.7z"/><path fill="currentColor" d="M173.3 0v26.7H200V373.3h-26.7V400h53.4V0H200zM360 26.7V373.3h26.7V26.7zM120 53.3h26.7V80H120zM93.3 80H120v26.7H93.3zM306.7 106.7V320h26.6V80h-26.6zM253.3 160v106.7H280V133.3h-26.7z"/><path fill="currentColor" d="M93.3 240V106.6h-80V293.4h80.1V240zm-26.6-80v106.7H40V133.3h26.7V160z"/><path fill="currentColor" d="M93.3 293.3H120V320H93.3zM120 320h26.7v26.7H120zM146.7 346.7h26.7v26.7h-26.7z"/></svg>MUSIIKKI';
      var iconMuted = '<svg width="14" height="14" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path fill="currentColor" d="M146.7 26.7h26.7v26.7h-26.7zM120 53.3h26.7V80H120zM93.3 80H120v26.7H93.3z"/><path fill="currentColor" d="M93.3 240V106.6h-80V293.4h80.1V240zm-26.6-80v106.7H40V133.3h26.7V160zM253.3 133.3H280V160h-26.7zM360 133.3h26.7V160H360zM280 160h26.7v26.7H280zM333.3 160H360v26.7h-26.7z"/><path fill="currentColor" d="M93.3 293.3H120V320H93.3zM306.7 186.7h26.7v26.7h-26.7zM120 320h26.7v26.7H120zM280 213.3h26.7V240H280z"/><path fill="currentColor" d="M333.3 213.3H360V240h-26.7zM146.7 346.7h26.7v26.7h-26.7zM253.3 240H280v26.7h-26.7zM360 240h26.7v26.7H360z"/><path fill="currentColor" d="M173.3 0v26.7H200V373.3h-26.7V400h53.4V0H200z"/></svg>MUSIIKKI';
      var iconLoading = '<span class="sound-loading">Ladataan...</span>';

      function updateSoundIcon() {
        if (!audioReady) {
          soundBtn.innerHTML = iconLoading;
          soundBtn.setAttribute('aria-label', 'Ladataan musiikkia');
          soundBtn.classList.remove('active');
        } else if (playing) {
          soundBtn.innerHTML = iconPlaying;
          soundBtn.setAttribute('aria-label', 'MykistÃ¤ musiikki');
          soundBtn.classList.add('active');
        } else {
          soundBtn.innerHTML = iconMuted;
          soundBtn.setAttribute('aria-label', 'Toista musiikki');
          soundBtn.classList.remove('active');
        }
      }

      // Check when audio is ready
      function checkAudioReady() {
        if (music1.readyState >= 3 || music2.readyState >= 3) {
          audioReady = true;
          updateSoundIcon();
        }
      }
      music1.addEventListener('canplaythrough', checkAudioReady);
      music2.addEventListener('canplaythrough', checkAudioReady);
      // Also check immediately in case already loaded
      checkAudioReady();

      // When track ends, play the other
      music1.onended = function() { if (playing) { current = music2; music2.play(); } };
      music2.onended = function() { if (playing) { current = music1; music1.play(); } };

      function toggleMusic() {
        if (playing) {
          music1.pause();
          music2.pause();
          playing = false;
          updateSoundIcon();
        } else {
          current.play().then(function() {
            playing = true;
            audioReady = true;
            updateSoundIcon();
          }).catch(function() {
            updateSoundIcon();
          });
        }
      }

      // Simple button - one tap toggles
      soundBtn.onclick = function(e) {
        e.preventDefault();
        toggleMusic();
      };

      // Auto-start music - try immediately, then on any interaction
      var autoStarted = false;
      function tryAutoStart() {
        if (autoStarted || playing) return;
        autoStarted = true;
        current.play().then(function() {
          playing = true;
          audioReady = true;
          updateSoundIcon();
          removeAutoListeners();
        }).catch(function() {
          autoStarted = false; // Allow retry on next interaction
        });
      }
      function removeAutoListeners() {
        document.removeEventListener('click', tryAutoStart);
        document.removeEventListener('keydown', tryAutoStart);
        document.removeEventListener('mousemove', tryAutoStart);
        document.removeEventListener('touchstart', tryAutoStart);
        document.removeEventListener('scroll', tryAutoStart);
      }
      // Try immediately on load
      tryAutoStart();
      // Fallback: try on any user interaction
      document.addEventListener('click', tryAutoStart);
      document.addEventListener('keydown', tryAutoStart);
      document.addEventListener('mousemove', tryAutoStart, { once: true });
      document.addEventListener('touchstart', tryAutoStart);
      document.addEventListener('scroll', tryAutoStart, { once: true });

      function showToast(msg, err) {
        var el = document.getElementById('toast');
        el.textContent = msg;
        el.className = 'toast show' + (err ? ' error' : '');
        setTimeout(function() { el.classList.remove('show'); }, 3000);
      }

      // Heart likes - localStorage tracking
      function getLikedMessages() {
        try {
          return JSON.parse(localStorage.getItem('xmas_likes_2025') || '[]');
        } catch (e) { return []; }
      }

      function hasLiked(id) {
        return getLikedMessages().indexOf(id) !== -1;
      }

      function markAsLiked(id) {
        var liked = getLikedMessages();
        if (liked.indexOf(id) === -1) {
          liked.push(id);
          try {
            localStorage.setItem('xmas_likes_2025', JSON.stringify(liked));
          } catch (e) {}
        }
      }

      function likeMessage(id, btn) {
        if (hasLiked(id)) return;

        btn.disabled = true;
        fetch('https://www.dude.fi/wp-json/xmas/v1/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id })
        })
        .then(function(res) {
          if (res.ok) return res.json();
          throw new Error();
        })
        .then(function(data) {
          markAsLiked(id);
          btn.classList.add('liked');
          btn.querySelector('svg').setAttribute('fill', 'currentColor');
          var countSpan = btn.querySelector('span');
          if (countSpan) {
            countSpan.textContent = data.likes;
          } else {
            btn.insertAdjacentHTML('beforeend', '<span>' + data.likes + '</span>');
          }
        })
        .catch(function() {
          btn.disabled = false;
        });
      }

      // Floating messages - alternate left/right
      var floatSide = 0;
      function showFloatingMessage(author, message, timestamp, isNew) {
        var el = document.createElement('div');
        el.className = 'float-msg' + (isNew ? ' new' : '');

        // Randomize position - on desktop avoid center (30-70%), on mobile anywhere
        var isMobile = window.innerWidth <= 600;
        var pos, side;
        if (isMobile) {
          // Mobile: anywhere from 5% to 60% from left
          pos = 5 + Math.random() * 55;
          el.style.left = pos + '%';
        } else {
          // Desktop: left side (5-28%) or right side (62-90%), avoid center
          if (floatSide % 2 === 0) {
            pos = 5 + Math.random() * 23;
            el.style.left = pos + '%';
            side = 'left';
          } else {
            pos = 5 + Math.random() * 28;
            el.style.right = 'calc(360px + ' + pos + '%)';
            side = 'right';
          }
        }
        // Randomize bottom position too (10-25%)
        el.style.bottom = (10 + Math.random() * 15) + '%';

        // Handle bubble tail for right-side bubbles
        if (side === 'right') {
          el.classList.add('right');
        }
        floatSide++;

        var timeStr = '';
        if (timestamp) {
          var now = new Date();
          var then = new Date(timestamp);
          var diff = Math.floor((now - then) / 1000);
          if (diff < 60) timeStr = 'juuri nyt';
          else if (diff < 3600) timeStr = Math.floor(diff / 60) + ' min sitten';
          else if (diff < 86400) timeStr = Math.floor(diff / 3600) + ' h sitten';
          else timeStr = Math.floor(diff / 86400) + ' pv sitten';
        }

        el.innerHTML = '<span class="float-msg-author">' + esc(author) + '</span>' +
                       '<span class="float-msg-text">' + esc(message.substring(0, 80)) + (message.length > 80 ? '...' : '') + '</span>' +
                       (timeStr ? '<span class="float-msg-time">' + timeStr + '</span>' : '');
        document.body.appendChild(el);

        // Santa reads the message
        var santa = document.getElementById('santa');
        santa.classList.add('reading');
        setTimeout(function() { santa.classList.remove('reading'); }, 2500);

        // Flash HUD notification only for new messages from others
        if (isNew) {
          var hud = document.querySelector('.hud');
          hud.classList.remove('notify');
          void hud.offsetWidth; // trigger reflow to restart animation
          hud.classList.add('notify');
          setTimeout(function() { hud.classList.remove('notify'); }, 2000);
        }

        // Remove after animation (12s)
        setTimeout(function() { el.remove(); }, 12500);
      }

      // Track last seen timestamp to show new ones floating
      var lastSeenTime = null;
      var seenMsgIds = {};
      var originalLoadMessages = loadMessages;

      loadMessages = function() {
        fetch('https://www.dude.fi/wp-json/xmas/v1/messages')
          .then(function(res) {
            if (res.ok) return res.json();
            throw new Error();
          })
          .then(function(msgs) {
            // Store for random old messages
            allMessages = msgs;
            var el = document.getElementById('messages');
            if (msgs.length == 0) {
              el.innerHTML = '<div class="no-msgs">Ole ensimmÃ¤inen tervehtijÃ¤!</div>';
            } else {
              // Check for new messages and show them floating + prepend to list
              var addedNew = false;
              if (lastSeenTime) {
                for (var i = 0; i < msgs.length; i++) {
                  var msgTime = new Date(msgs[i].timestamp).getTime();
                  // Skip if this is the message we just submitted (prevent double bubble)
                  var isOwnMsg = window.justSubmittedMsg === msgs[i].author + '::' + msgs[i].message;
                  if (msgTime > lastSeenTime && !seenMsgIds[msgs[i].id] && !isOwnMsg) {
                    seenMsgIds[msgs[i].id] = true;
                    showFloatingMessage(msgs[i].author, msgs[i].message, msgs[i].timestamp, true);
                    // Prepend to shoutbox immediately
                    var newMsgHtml = '<div class="msg new-highlight">' +
                      '<span class="msg-author">' + esc(msgs[i].author) + ':</span>' +
                      '<span class="msg-text">' + esc(msgs[i].message) + '</span>' +
                      '<div class="msg-footer"><span class="msg-time">juuri nyt</span>' +
                      '<button class="msg-heart" data-id="' + esc(msgs[i].id) + '">' +
                      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></button></div></div>';
                    el.insertAdjacentHTML('afterbegin', newMsgHtml);
                    addedNew = true;
                  }
                }
              }
              // Update lastSeenTime to the newest message timestamp
              var maxTime = 0;
              for (var j = 0; j < msgs.length; j++) {
                var t = new Date(msgs[j].timestamp).getTime();
                if (t > maxTime) maxTime = t;
                seenMsgIds[msgs[j].id] = true;
              }
              lastSeenTime = maxTime;

              // Only rebuild full list if no new messages were prepended
              if (!addedNew) el.innerHTML = msgs.map(function(m) {
                var isLiked = hasLiked(m.id);
                var likeCount = m.likes || 0;
                return '<div class="msg">' +
                  '<span class="msg-author">' + esc(m.author) + ':</span>' +
                  '<span class="msg-text">' + esc(m.message) + '</span>' +
                  '<div class="msg-footer">' +
                    '<span class="msg-time">' + fmt(m.timestamp) + '</span>' +
                    '<button class="msg-heart' + (isLiked ? ' liked' : '') + '" data-id="' + esc(m.id) + '" ' + (isLiked ? 'disabled' : '') + '>' +
                      '<svg viewBox="0 0 24 24" fill="' + (isLiked ? 'currentColor' : 'none') + '" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>' +
                      (likeCount > 0 ? '<span>' + likeCount + '</span>' : '') +
                    '</button>' +
                  '</div>' +
                '</div>';
              }).join('');
              el.querySelectorAll('.msg-heart:not([disabled])').forEach(function(btn) {
                btn.onclick = function() { likeMessage(btn.dataset.id, btn); };
              });
            }
          })
          .catch(function() {
            // Don't clear messages on error - keep existing content
          });
      };

      // Start message loading and polling (after override is defined)
      var allMessages = [];
      loadMessages();
      var poll = setInterval(loadMessages, 6000);

      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          clearInterval(poll);
        } else {
          loadMessages();
          poll = setInterval(loadMessages, 6000);
        }
      });

      // Visitor counter - polls every 5 seconds
      function loadVisitors() {
        fetch('https://www.dude.fi/wp-json/xmas/v1/visitors')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            var count = Math.max(1, data.visitors || 0); // At least 1 (you!)
            document.getElementById('visitorCount').textContent = count;
            document.getElementById('visitorWord').textContent = count === 1 ? 'tonttu' : 'tonttua';
          })
          .catch(function() {});
      }

      loadVisitors();
      setInterval(loadVisitors, 5000);

      // Total visitors counter
      function loadTotalVisitors() {
        fetch('https://www.dude.fi/wp-json/xmas/v1/total-visitors')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            var total = data.total || 0;
            var el = document.getElementById('totalVisitors');
            if (total > 0) {
              document.getElementById('totalCount').textContent = total;
              el.style.display = '';
            } else {
              el.style.display = 'none';
            }
          })
          .catch(function() {
            document.getElementById('totalVisitors').style.display = 'none';
          });
      }
      loadTotalVisitors();
      setInterval(loadTotalVisitors, 60000); // Update every minute

      // Randomly show older messages floating (allMessages populated by loadMessages)
      function showRandomOldMessage() {
        if (allMessages.length < 2) return;
        // Pick a random message (not the newest)
        var idx = Math.floor(Math.random() * (allMessages.length - 1)) + 1;
        var msg = allMessages[idx];
        if (msg) {
          showFloatingMessage(msg.author, msg.message, msg.timestamp);
        }
      }
      // Show a random old message every 12-20 seconds
      function scheduleRandomMessage() {
        var delay = 12000 + Math.random() * 8000;
        setTimeout(function() {
          showRandomOldMessage();
          scheduleRandomMessage();
        }, delay);
      }
      scheduleRandomMessage();

      // Character speech bubbles
      function showSpeechBubble() {
        var chars = document.querySelectorAll('.character');
        if (chars.length == 0) return;

        var charIndex = Math.floor(Math.random() * chars.length);
        var charEl = chars[charIndex];
        var personData = team[charIndex];

        // Remove any existing bubble on this character
        var existing = charEl.querySelector('.speech-bubble');
        if (existing) existing.remove();

        // Pick random phrase
        var phrase = personData.says[Math.floor(Math.random() * personData.says.length)];

        var bubble = document.createElement('div');
        bubble.className = 'speech-bubble';
        bubble.textContent = phrase;
        charEl.appendChild(bubble);

        // Remove after animation
        setTimeout(function() { bubble.remove(); }, 3500);
      }

      // Show speech bubble every 4-8 seconds
      function scheduleSpeech() {
        var delay = 4000 + Math.random() * 4000;
        setTimeout(function() {
          showSpeechBubble();
          scheduleSpeech();
        }, delay);
      }
      scheduleSpeech();

      // CEO speaks faster (every 2-4 seconds)
      function showCEOBubble() {
        var ceoIndex = team.findIndex(function(p) { return p.sayFast; });
        if (ceoIndex === -1) return;

        var chars = document.querySelectorAll('.character');
        if (chars.length <= ceoIndex) return;

        var charEl = chars[ceoIndex];
        var existing = charEl.querySelector('.speech-bubble');
        if (existing) existing.remove();

        var phrase = team[ceoIndex].says[Math.floor(Math.random() * team[ceoIndex].says.length)];
        var bubble = document.createElement('div');
        bubble.className = 'speech-bubble';
        bubble.textContent = phrase;
        charEl.appendChild(bubble);
        setTimeout(function() { bubble.remove(); }, 3500);
      }

      function scheduleCEOSpeech() {
        var delay = 5000 + Math.random() * 5000;
        setTimeout(function() {
          showCEOBubble();
          scheduleCEOSpeech();
        }, delay);
      }
      scheduleCEOSpeech();

      // Marquee - clone content for seamless loop
      (function initMarquee() {
        var track = document.getElementById('marqueeTrack');
        if (!track) return;

        // Clone the span to fill the track
        var original = track.querySelector('span');
        if (!original) return;

        // Add clone
        var clone = original.cloneNode(true);
        clone.setAttribute('aria-hidden', 'true');
        track.appendChild(clone);

        // Calculate dynamic duration based on text length
        var textLen = original.textContent.length;
        var duration = Math.max(20, Math.min(80, textLen * 0.2));
        track.style.setProperty('--marquee-duration', duration + 's');

        // Start animation
        track.setAttribute('data-animated', 'true');
      })();

      // Character click animations
      var charAnimations = ['anim-wave', 'anim-jump', 'anim-drink', 'anim-dance'];
      document.addEventListener('click', function(e) {
        var charEl = e.target.closest('.character');
        if (!charEl) return;

        // Remove any existing animation
        charAnimations.forEach(function(c) { charEl.classList.remove(c); });

        // Add random animation
        var anim = charAnimations[Math.floor(Math.random() * charAnimations.length)];
        charEl.classList.add(anim);

        // Remove after animation completes
        setTimeout(function() {
          charEl.classList.remove(anim);
        }, 800);
      });

      // Idle animations disabled - caused rendering glitches with box-shadow sprites
      // function startIdleAnimations() { ... }

      // Openable gifts
      var giftContents = [
        { emoji: 'ðŸ¬', msg: 'Karkkia!' },
        { emoji: 'ðŸ§¸', msg: 'Nalle!' },
        { emoji: 'ðŸŽ®', msg: 'Pelikonsoli!' },
        { emoji: 'ðŸ«', msg: 'Suklaata!' },
        { emoji: 'ðŸŽ¸', msg: 'Kitara!' },
        { emoji: 'ðŸ“±', msg: 'Uusi puhelin!' },
        { emoji: 'ðŸŽ§', msg: 'Kuulokkeet!' },
        { emoji: 'âŒš', msg: 'Kello!' },
        { emoji: 'ðŸ§£', msg: 'Kaulahuivi!' },
        { emoji: 'ðŸŽ', msg: 'Lahjakortti!' },
        { emoji: 'ðŸª', msg: 'Pipareita!' },
        { emoji: 'â˜•', msg: 'Kahvimuki!' }
      ];

      function openGift(gift) {
        if (gift.classList.contains('opened')) return;
        gift.classList.add('opened');

        var content = giftContents[Math.floor(Math.random() * giftContents.length)];

        var contentEl = document.createElement('div');
        contentEl.className = 'gift-content';
        contentEl.textContent = content.emoji;
        gift.appendChild(contentEl);

        var msgEl = document.createElement('div');
        msgEl.className = 'gift-msg';
        msgEl.textContent = content.msg;
        gift.appendChild(msgEl);

        // Mini confetti burst
        for (var i = 0; i < 12; i++) {
          var conf = document.createElement('div');
          conf.style.cssText = 'position:absolute;width:6px;height:6px;background:' +
            ['#f00','#0f0','#ff0','#f8d878','#0af','#f0f'][Math.floor(Math.random()*6)] +
            ';left:50%;top:50%;z-index:30;pointer-events:none;border-radius:50%;' +
            'animation:giftConfetti 0.8s ease-out forwards;' +
            '--angle:' + (i * 30) + 'deg;--dist:' + (30 + Math.random()*20) + 'px;';
          gift.appendChild(conf);
        }
      }

      document.querySelectorAll('.gift').forEach(function(gift) {
        gift.addEventListener('click', function() { openGift(gift); });
      });

      // Add confetti keyframes for gifts
      var giftConfStyle = document.createElement('style');
      giftConfStyle.textContent = '@keyframes giftConfetti{0%{transform:translate(-50%,-50%);}100%{transform:translate(calc(-50% + cos(var(--angle)) * var(--dist)), calc(-50% + sin(var(--angle)) * var(--dist) - 20px));opacity:0;}}';
      document.head.appendChild(giftConfStyle);

      // Moon click - Santa sleigh flies across
      var moon = document.querySelector('.moon');
      var sleigh = document.getElementById('sleighShadow');
      if (moon && sleigh) {
        moon.style.cursor = 'pointer';
        moon.addEventListener('click', function() {
          sleigh.classList.remove('flying');
          void sleigh.offsetWidth; // Trigger reflow
          sleigh.classList.add('flying');
          setTimeout(function() {
            sleigh.classList.remove('flying');
          }, 3100);
        });
      }

      // Cat click - wakes up briefly
      var cat = document.getElementById('cornerCat');
      if (cat) {
        cat.addEventListener('click', function() {
          cat.classList.add('awake');
          setTimeout(function() {
            cat.classList.remove('awake');
          }, 2000);
        });
      }

      // Christmas countdown
      var xmasDate = new Date(2025, 11, 25, 0, 0, 0); // Dec 25, 2025
      var testXmas = new URLSearchParams(window.location.search).get('testxmas') === '1';

      function isXmasOrAfter() {
        return testXmas || new Date() >= xmasDate;
      }

      function updateCountdown() {
        var now = new Date();
        var diff = xmasDate - now;

        var el = document.getElementById('countdownTime');
        var label = document.querySelector('.countdown-label');

        // Check if it's Christmas or after (or testing)
        if (testXmas || diff <= 0) {
          el.innerHTML = 'ðŸŽ„ HYVÃ„Ã„ JOULUA! ðŸŽ„';
          el.classList.add('countdown-done');
          label.textContent = '';
          // Trigger confetti or special effect
          if (!window.xmasConfettiShown) {
            window.xmasConfettiShown = true;
            triggerXmasConfetti();
            closeShoutbox();
          }
        } else {
          var days = Math.floor(diff / (1000 * 60 * 60 * 24));
          var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          var mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          var secs = Math.floor((diff % (1000 * 60)) / 1000);

          el.innerHTML =
            '<span class="countdown-unit"><span class="countdown-num">' + String(days).padStart(2, '0') + '</span><span class="countdown-lbl">p</span></span>' +
            '<span class="countdown-sep">:</span>' +
            '<span class="countdown-unit"><span class="countdown-num">' + String(hours).padStart(2, '0') + '</span><span class="countdown-lbl">t</span></span>' +
            '<span class="countdown-sep">:</span>' +
            '<span class="countdown-unit"><span class="countdown-num">' + String(mins).padStart(2, '0') + '</span><span class="countdown-lbl">m</span></span>' +
            '<span class="countdown-sep">:</span>' +
            '<span class="countdown-unit"><span class="countdown-num">' + String(secs).padStart(2, '0') + '</span><span class="countdown-lbl">s</span></span>';
        }
      }

      // Close shoutbox on Christmas
      function closeShoutbox() {
        var form = document.getElementById('msgForm');
        var msgList = document.getElementById('messages');
        if (form) {
          form.style.display = 'none';
        }
        // Add info box before messages
        if (msgList && !document.getElementById('shoutboxClosed')) {
          var infoBox = document.createElement('div');
          infoBox.id = 'shoutboxClosed';
          infoBox.style.cssText = 'color:rgba(255,255,255,0.5);font-size:10px;line-height:1.5;padding:8px 0;';
          infoBox.innerHTML = 'Joulupukin kuuma linja on nyt suljettu. Kiitos kaikille terveisistÃ¤ ja hyvÃ¤Ã¤ joulua!';
          msgList.parentNode.insertBefore(infoBox, msgList);
        }
      }

      // Check on load if shoutbox should be closed
      if (isXmasOrAfter()) {
        closeShoutbox();
      }

      function triggerXmasConfetti() {
        // Simple confetti burst
        for (var i = 0; i < 50; i++) {
          var confetti = document.createElement('div');
          confetti.style.cssText = 'position:fixed;width:10px;height:10px;background:' +
            ['#f00','#0f0','#ff0','#f8d878','#fff'][Math.floor(Math.random()*5)] +
            ';left:' + Math.random()*100 + '%;top:-10px;z-index:9999;pointer-events:none;' +
            'animation:confettiFall ' + (2+Math.random()*2) + 's ease-out forwards;' +
            'animation-delay:' + (Math.random()*0.5) + 's;';
          document.body.appendChild(confetti);
          setTimeout(function() { confetti.remove(); }, 5000);
        }
      }

      // Add confetti keyframes
      var confettiStyle = document.createElement('style');
      confettiStyle.textContent = '@keyframes confettiFall{0%{transform:translateY(0) rotate(0deg);opacity:1;}100%{transform:translateY(100vh) rotate(720deg);opacity:0;}}';
      document.head.appendChild(confettiStyle);

      updateCountdown();
      setInterval(updateCountdown, 1000);

    })();
  </script>
</body>
</html>
